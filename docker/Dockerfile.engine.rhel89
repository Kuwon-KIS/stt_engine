# ============================================================================
# STT Engine - RHEL 8.9 Optimized with CUDA 12.9 + cuDNN
# 
# Build Platform: RHEL 8.9 AMI EC2
# Build Environment: Online (requires internet)
# Target Server: RHEL 8.9 with CUDA 12.9 + NVIDIA Driver 575.57.08
# Base Image: ubi8/python-311 (Red Hat Universal Base Image)
# glibc: 2.28 (RHEL 8.9 ê¸°ë³¸ê°’ - í˜¸í™˜ì„± 100%)
# cuDNN: wheel íŒ¨í‚¤ì§€ ì„¤ì¹˜
# Final Size: ~1.5GB (compressed tar.gz ~500MB)
#
# ë¹Œë“œ ëª…ë ¹ì–´:
#   docker build --platform linux/amd64 -t stt-engine:cuda129-rhel89-v1.2 -f docker/Dockerfile.engine.rhel89 .
# ============================================================================

FROM --platform=linux/amd64 registry.access.redhat.com/ubi8/python-311:latest

LABEL maintainer="STT Engine Team"
LABEL description="STT Engine RHEL 8.9 Optimized with CUDA 12.9"
LABEL os="RHEL 8.9"
LABEL glibc="2.28"
LABEL cuda.version="12.9"
LABEL cudnn.version="9.0.0.312"
LABEL pytorch.version="2.6.0"

# ðŸ’¡ ì¤‘ìš”: UBI 8 ì´ë¯¸ì§€ëŠ” ê¸°ë³¸ìœ¼ë¡œ non-root ì‚¬ìš©ìžë¡œ ì„¤ì •ë¨
# FROM ë°”ë¡œ ë‹¤ìŒì— rootë¡œ ì „í™˜í•˜ì—¬ ì´í›„ ëª¨ë“  RUN ë¸”ë¡ì´ root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ í•¨
USER root

# ============================================================================
# Step 1: Subscription Manager ì™„ì „ ë¹„í™œì„±í™” + Rootless ì‚¬ìš©ìž ìƒì„±
# ============================================================================

# ðŸ’¡ ëª¨ë“  root ê¶Œí•œ ìž‘ì—…ì„ í•œ RUN ë¸”ë¡ì—ì„œ ìˆ˜í–‰ (ê¶Œí•œ ë¬¸ì œ ë°©ì§€)
RUN rm -rf /etc/rhsm /etc/pki/entitlement* 2>/dev/null || true && \
    subscription-manager clean 2>/dev/null || true && \
    yum clean all 2>/dev/null || true && \
    rm -rf /var/cache/yum/* && \
    # Non-root ì‚¬ìš©ìž ìƒì„± (ì¡°ê±´ë¶€: ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©´ UID 2000ìœ¼ë¡œ ìƒì„±)
    (id stt-user >/dev/null 2>&1 || useradd -m -u 2000 -s /bin/bash stt-user) && \
    # sudo ê¶Œí•œ ë¶€ì—¬
    mkdir -p /etc/sudoers.d && \
    echo "stt-user ALL=(ALL) NOPASSWD: /usr/bin/yum" >> /etc/sudoers.d/stt-user && \
    chmod 0440 /etc/sudoers.d/stt-user

# ============================================================================
# Step 2: ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (ì•„ì§ rootë¡œ ì‹¤í–‰ ì¤‘)
# ============================================================================

RUN yum install -y \
    # CA ì¸ì¦ì„œ (SSL/TLS)
    ca-certificates \
    openssl \
    curl \
    wget \
    \
    # Audio/Media ì²˜ë¦¬ (Python librosaë¡œ ëŒ€ì²´)
    libsndfile \
    \
    # ê°œë°œ ë„êµ¬
    make \
    gcc \
    gcc-c++ \
    && yum clean all \
    && rm -rf /var/cache/yum/*

# ============================================================================
# Step 3: ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„± (rootë¡œ ì‹¤í–‰)
# ============================================================================

WORKDIR /app

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
RUN mkdir -p /app/models /app/logs /app/audio && \
    chmod -R 755 /app

# ============================================================================
# Step 4: cuDNN wheel ì„¤ì¹˜ (nvidia-cudnn-cu12) - ROOTë¡œ ì‹¤í–‰
# 
# RHEL 8.9ì—ì„œ pipë¥¼ í†µí•œ cuDNN ì„¤ì¹˜
# ë²„ì „: 9.0.0.312 (CUDA 12.x í˜¸í™˜)
# ============================================================================

RUN python3.11 -m pip install --upgrade nvidia-cudnn-cu12==9.0.0.312

# ============================================================================
# Step 5: LD_LIBRARY_PATH ì„¤ì • (cuDNN ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ)
# ============================================================================

ENV LD_LIBRARY_PATH=/usr/local/lib/python3.11/site-packages/nvidia/cudnn/lib:${LD_LIBRARY_PATH}

# ============================================================================
# Step 6: Python íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì—…ê·¸ë ˆì´ë“œ - ROOTë¡œ ì‹¤í–‰
# ============================================================================

RUN python3.11 -m pip install --upgrade \
    --trusted-host pypi.org \
    --trusted-host files.pythonhosted.org \
    pip setuptools wheel

# ============================================================================
# Step 7: Whisper ë° ì˜ì¡´ì„± ì„¤ì¹˜ (PyTorch ì œì™¸) - ROOTë¡œ ì‹¤í–‰
# 
# RHEL 8.9 í˜¸í™˜ ë²„ì „ ì‚¬ìš©:
# - faster-whisper: CTranslate2 ê¸°ë°˜ ë¹ ë¥¸ ì¶”ë¡ 
# - openai-whisper: fallback (ëŠë¦¼)
# ============================================================================

RUN python3.11 -m pip install --trusted-host files.pythonhosted.org \
    # Whisper implementations
    faster-whisper==1.2.1 \
    ctranslate2==4.7.1 \
    openai-whisper==20231117 \
    \
    # Audio processing
    librosa==0.10.0 \
    scipy==1.12.0 \
    numpy==1.24.3 \
    \
    # Model management & transformers (flexible versions for compatibility)
    huggingface-hub>=0.21 \
    "transformers>=4.30,<6" \
    \
    # Web framework
    fastapi==0.109.0 \
    uvicorn==0.27.0 \
    requests==2.31.0 \
    pydantic==2.5.3 \
    python-multipart==0.0.6 \
    \
    # Configuration
    python-dotenv==1.0.0 \
    pyyaml==6.0.1

# ============================================================================
# Step 8: PyTorch ì„¤ì¹˜ (ë§ˆì§€ë§‰) - ROOTë¡œ ì‹¤í–‰
# 
# CUDA 12.4 ê³µì‹ ì§€ì› ë²„ì „ ì‚¬ìš©
# RHEL 8.9ì˜ CUDA 12.9 Runtimeê³¼ forward compatible
# torchaudioë„ í¬í•¨ (whisperì—ì„œ í•„ìˆ˜)
# ============================================================================

RUN python3.11 -m pip install --no-deps \
    --index-url https://download.pytorch.org/whl/cu124 \
    torch==2.6.0 \
    torchaudio==2.6.0

# ============================================================================
# Step 9: ì‚¬ìš©ìž ì „í™˜ (ì´í›„ ëª¨ë“  ìž‘ì—…ì€ stt-userë¡œ) - ëª¨ë“  pip ì„¤ì¹˜ ì™„ë£Œ í›„
# ============================================================================

USER stt-user

# ============================================================================
# Step 10: ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬ (stt-user ê¶Œí•œ)
# ============================================================================

# ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
COPY --chown=stt-user:stt-user api_server.py /app/
COPY --chown=stt-user:stt-user stt_engine.py /app/
COPY --chown=stt-user:stt-user requirements.txt /app/

# Python í™˜ê²½ ë³€ìˆ˜
ENV PYTHONUNBUFFERED=1
ENV HF_HOME=/app/models
ENV STT_DEVICE=cpu

# ============================================================================
# Step 11: í—¬ìŠ¤ ì²´í¬ ë° í¬íŠ¸ ë…¸ì¶œ
# ============================================================================

# Health check: 30ì´ˆë§ˆë‹¤ ì²´í¬, 10ì´ˆ íƒ€ìž„ì•„ì›ƒ, 3ë²ˆ ì‹¤íŒ¨ ì‹œ unhealthy
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8003/health || exit 1

# STT API í¬íŠ¸
EXPOSE 8003

# ============================================================================
# Step 12: ì‹œìž‘ ëª…ë ¹ì–´
# ============================================================================

CMD ["python3.11", "api_server.py"]
