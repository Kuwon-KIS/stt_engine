version: '3.8'

# ============================================================================
# ⚠️  참고: 이 파일은 docker-compose 실행 예제입니다.
#     실제 로컬 개발에서는 'docker run' 명령어 사용을 권장합니다.
#     각 서비스를 독립적으로 관리하고 테스트하기 위해서입니다.
# ============================================================================
#
# docker-compose 사용 시:
#   docker-compose -f docker/docker-compose.local.yml up -d
#   docker-compose -f docker/docker-compose.local.yml logs -f api-server
#   docker-compose -f docker/docker-compose.local.yml down
#
# docker run 사용 시 (권장 - Mac 개발 환경):
#
#   1️⃣  네트워크 생성:
#   docker network create stt-network
#
#   2️⃣  STT Engine 실행:
#   docker run -d --name stt-engine-local -p 8003:8003 \
#     -e STT_DEVICE=cpu \
#     -v $(pwd)/models:/app/models \
#     -v $(pwd)/audio/samples:/app/audio/samples \
#     stt-engine:local
#
#   3️⃣  Web UI 실행:
#   docker run -d --name stt-web-ui-local -p 8100:8100 \
#     -e STT_API_URL=http://host.docker.internal:8003 \
#     -v $(pwd)/web_ui/data:/app/data \
#     -v $(pwd)/web_ui/logs:/app/logs \
#     stt-web-ui:local
#
#   4️⃣  접속:
#   - Web UI: http://localhost:8100
#   - STT API: http://localhost:8003
#
#   5️⃣  로그 확인:
#   docker logs -f stt-engine-local
#   docker logs -f stt-web-ui-local
#
#   6️⃣  종료 및 정리:
#   docker stop stt-engine-local stt-web-ui-local
#   docker rm stt-engine-local stt-web-ui-local
# ============================================================================

services:
  # API 서버 (STT Engine)
  # Mac에서: host.docker.internal로 호스트 포트 접근 가능
  api-server:
    image: stt-engine:local
    container_name: stt-engine-local
    
    ports:
      - "8003:8003"
    
    networks:
      - stt-network
    
    volumes:
      - ../models:/app/models              # STT 모델 디렉토리
      - ../audio/samples:/app/audio/samples # 입력 오디오 파일
      - ../logs:/app/logs                  # 로그 파일
    
    environment:
      - PYTHONUNBUFFERED=1
      - HF_HOME=/app/models
      - STT_DEVICE=cpu                     # Mac에서는 CPU 사용
      - LOG_LEVEL=INFO
      - ENVIRONMENT=local                  # 로컬 개발 환경
    
    # 헬스 체크
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    restart: unless-stopped

  # Web UI (Flask/FastAPI 기반)
  web-ui:
    image: stt-web-ui:local
    container_name: stt-web-ui-local
    
    ports:
      - "8100:8100"
    
    networks:
      - stt-network
    
    volumes:
      - ../web_ui/data:/app/data
      - ../web_ui/logs:/app/logs
    
    environment:
      - PYTHONUNBUFFERED=1
      - STT_API_URL=http://host.docker.internal:8003  # Mac: host.docker.internal 사용
      - WEB_HOST=0.0.0.0
      - WEB_PORT=8100
      - LOG_LEVEL=INFO
      - ENVIRONMENT=local
    
    depends_on:
      api-server:
        condition: service_healthy
    
    # 헬스 체크
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    restart: unless-stopped

# ============================================================================
# 네트워크 설정
# ============================================================================
networks:
  stt-network:
    driver: bridge
    # Mac에서 host.docker.internal을 통해 호스트 머신 포트에 접근 가능
    # 사용 예: http://host.docker.internal:8003
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# 네트워크 정의
networks:
  default:
    name: stt-local-network
    driver: bridge
