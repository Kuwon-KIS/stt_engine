FROM python:3.11-slim

WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsndfile1 \
    git \
    curl \
    tar \
    gzip \
    && rm -rf /var/lib/apt/lists/*

# Python ì—…ê·¸ë ˆì´ë“œ
RUN pip install --upgrade pip setuptools wheel

# ìš”êµ¬ì‚¬í•­ ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
COPY . .

# ëª¨ë¸ ìë™ ì••ì¶• í•´ì œ (ìˆìœ¼ë©´)
RUN mkdir -p /app/models && \
    if [ -f /app/models/whisper-model.tar.gz ]; then \
        echo "ğŸ“¦ ëª¨ë¸ ì••ì¶• íŒŒì¼ ê°ì§€, ìë™ í•´ì œ ì¤‘..."; \
        cd /app/models && \
        tar -xzf whisper-model.tar.gz && \
        rm whisper-model.tar.gz && \
        echo "âœ… ëª¨ë¸ ì••ì¶• í•´ì œ ì™„ë£Œ"; \
    else \
        echo "âš ï¸  ì••ì¶• ëª¨ë¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤, ì„œë²„ ì‹œì‘ì‹œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤"; \
    fi

# ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p audio logs

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8001

# í—¬ìŠ¤ ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

# ì„œë²„ ì‹¤í–‰
CMD ["python", "api_server.py"]
