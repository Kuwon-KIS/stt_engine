<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>분석 결과 - KIS 불완전판매 탐지 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info #userInfo {
            font-size: 14px;
            font-weight: 500;
        }

        .btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .btn-refresh {
            background-color: #4CAF50;
        }

        .btn-refresh:hover {
            background-color: #45a049;
        }

        .btn-back {
            background-color: #2196F3;
        }

        .btn-back:hover {
            background-color: #0b7dda;
        }

        .btn-export {
            background-color: #667eea;
        }

        .btn-export:hover {
            background-color: #5568d3;
        }

        .btn-view {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-view:hover {
            background-color: #5568d3;
        }

        .container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .analysis-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .analysis-header h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .analysis-actions {
            display: flex;
            gap: 10px;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card.warning {
            background-color: #ffebee;
            border-left: 4px solid #c62828;
        }

        .stat-card.warning .stat-value {
            color: #c62828;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }



        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: #1976d2;
            color: white;
        }

        .status-running {
            background-color: #f57c00;
            color: white;
        }

        .status-completed {
            background-color: #388e3c;
            color: white;
        }

        .status-error {
            background-color: #c62828;
            color: white;
        }

        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .result-safe {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .result-warning {
            background-color: #fff3cd;
            color: #ff9800;
        }

        .result-danger {
            background-color: #ffebee;
            color: #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .status-banner {
            background-color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 50px;
            transition: all 0.3s ease;
        }

        .status-banner.processing {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
        }

        .status-banner.completed {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4CAF50;
        }

        .status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .status-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-text {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .status-progress-bar {
            flex: 1;
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            max-width: 300px;
        }

        .status-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .status-details {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }

        .loading-spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff9800;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            min-width: 250px;
            max-width: 400px;
        }

        .notification.success {
            background-color: #e8f5e9;
            color: #388e3c;
            border: 1px solid #388e3c;
        }

        .notification.error {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #d32f2f;
        }

        .notification.warning {
            background-color: #fff3e0;
            color: #f57c00;
            border: 1px solid #f57c00;
        }

        .notification.info {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #1976d2;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background-color: #f5f5f5;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .history-item-meta {
            font-size: 12px;
            color: #999;
        }

        .history-item-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-processing {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-pending {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .badge-failed {
            background-color: #f8d7da;
            color: #721c24;
        }

        .stt-text-content {
            margin-top: 10px;
        }

        .stt-text-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .stt-text-area {
            width: 100%;
            min-height: 300px;
            max-height: 400px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            resize: none;
            background-color: #f8f9fa;
            overflow-y: auto;
        }

        .stt-text-area:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
        }

        .audio-player {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .audio-player audio {
            width: 100%;
            height: 32px;
            max-width: 250px;
        }

        .audio-player audio::-webkit-media-controls-panel {
            background-color: #f8f9fa;
        }

        /* Checkbox selection styles */
        .checkbox-cell {
            text-align: center;
            padding: 8px;
        }

        .file-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .selection-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .selection-count {
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }

        .btn-rerun {
            background-color: #ff9800;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-rerun:hover:not(:disabled) {
            background-color: #f57c00;
        }

        .btn-rerun:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-select-all {
            background-color: #6c757d;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-select-all:hover {
            background-color: #5a6268;
        }

        /* Table control bar */
        .table-control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            border-radius: 8px 8px 0 0;
        }

        .btn-control {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .btn-control:hover {
            background-color: #5a6268;
        }

        .btn-control-rerun {
            background-color: #ff9800;
        }

        .btn-control-rerun:hover:not(:disabled) {
            background-color: #f57c00;
        }

        .btn-control-rerun:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .table-container table {
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>KIS 불완전판매 탐지 시스템</h1>
        <div class="user-info">
            <span id="userInfo"></span>
            <button class="btn btn-back" onclick="goBack()">← 돌아가기</button>
            <button class="btn" onclick="logout()">로그아웃</button>
        </div>
    </div>

    <div class="container">
        <!-- 분석 정보 -->
        <div class="analysis-header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <h2 style="margin: 0;">분석 결과</h2>
                <span style="color: #999; font-size: 20px; font-weight: 300;">|</span>
                <p id="folderInfo" style="color: #666; font-size: 20px; font-weight: 500; margin: 0;">폴더: 로딩 중...</p>
            </div>
            <div class="analysis-actions">
                <button class="btn btn-refresh" onclick="refreshProgress()">새로고침</button>
                <button class="btn btn-back" onclick="showHistoryModal()">이전 분석 보기</button>
                <button class="btn btn-export" onclick="exportResults()">결과 내보내기</button>
            </div>
        </div>

        <!-- 로딩 상태 -->
        <div id="loadingSection" class="status-banner processing" style="display: none;">
            <div class="status-icon">
                <div class="loading-spinner-small"></div>
            </div>
            <div class="status-content">
                <span class="status-text">분석 중...</span>
                <span class="status-details" id="currentFile" style="display: none; color: #666; font-size: 12px; margin-top: 5px;"></span>
                <div class="status-progress-bar">
                    <div class="status-progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <span class="status-details" id="progressText">0%</span>
            </div>
        </div>

        <!-- 완료 상태 -->
        <div id="completedSection" class="status-banner completed" style="display: none;">
            <div class="status-icon">✓</div>
            <div class="status-content">
                <span class="status-text">분석 완료!</span>
                <span class="status-details" id="completedText">모든 파일 처리 완료</span>
            </div>
        </div>

        <!-- 통계 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">총 파일</div>
                <div class="stat-value" id="totalFiles">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">분석 완료</div>
                <div class="stat-value" id="completedFiles">0</div>
            </div>
            <div class="stat-card" id="suspiciousCard">
                <div class="stat-label">불완전판매 탐지</div>
                <div class="stat-value" id="suspiciousCount">0</div>
            </div>
        </div>

        <!-- 결과 테이블 -->
        <div class="table-container">
            <!-- 테이블 컨트롤 바 with 필터 -->
            <div class="table-control-bar" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; flex-wrap: wrap; gap: 16px;">
                <!-- 좌측: 선택 컨트롤 -->
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-control btn-control-rerun" id="rerunBtn" onclick="rerunSelectedFiles()" disabled style="padding: 6px 14px; font-size: 13px;">
                        선택 파일 재실행 (<span id="selectedCountBadge">0</span>)
                    </button>
                </div>
                
                <!-- 우측: 필터 영역 -->
                <div id="filterSection" style="display: none; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <!-- 분석상태 필터 -->
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <label style="font-weight: 600; color: #555; font-size: 13px; white-space: nowrap;">분석상태</label>
                        <select id="statusFilter" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; background-color: white;">
                            <option value="all">전체</option>
                            <option value="pending">대기중</option>
                            <option value="processing">분석중</option>
                            <option value="completed">완료</option>
                            <option value="failed">실패</option>
                        </select>
                    </div>
                    
                    <div style="height: 20px; width: 1px; background-color: #ccc;"></div>
                    
                    <!-- 분석 결과 필터 -->
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <label style="font-weight: 600; color: #555; font-size: 13px; white-space: nowrap;">분석 결과</label>
                        <select id="riskFilter" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; background-color: white;">
                            <option value="all">전체</option>
                            <option value="safe">이상 없음</option>
                            <option value="danger">위반 탐지</option>
                        </select>
                    </div>
                    
                    <div style="height: 20px; width: 1px; background-color: #ccc;"></div>
                    
                    <!-- 필터 통계 및 리셋 -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: #666; white-space: nowrap;">표시: <strong id="filteredCount">0</strong>/<strong id="totalCount">0</strong></span>
                        <button onclick="resetFilters()" class="btn" style="background-color: #6c757d; color: white; padding: 6px 14px; font-size: 13px; white-space: nowrap; border: none; border-radius: 4px; cursor: pointer;">
                            필터 초기화
                        </button>
                    </div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th style="width: 4%; text-align: center;">
                            <input type="checkbox" id="selectAllCheckbox" class="file-checkbox" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 5%; text-align: center;">번호</th>
                        <th style="width: 18%; text-align: left;">파일명</th>
                        <th style="width: 20%; text-align: left;">오디오</th>
                        <th style="width: 12%; text-align: center;">분석 상태</th>
                        <th style="width: 10%; text-align: center;">카테고리</th>
                        <th style="width: 12%; text-align: center;">분석 결과</th>
                        <th style="width: 10%; text-align: center;">분석 내용</th>
                    </tr>
                </thead>
                <tbody id="analysisTableBody">
                    <tr>
                        <td colspan="8" class="empty-state">분석 대기 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 분석 이력 모달 -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>분석 이력</h2>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="folderSelector">
                    <label for="folderSelect" style="margin-bottom: 10px; display: block;">폴더 선택 (선택사항)</label>
                    <select id="folderSelect" style="width: 100%; padding: 8px; margin-bottom: 20px;">
                        <option value="">전체 폴더</option>
                    </select>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
            <div class="modal-footer">
                <button class="action-button secondary-button" onclick="closeHistoryModal()">닫기</button>
            </div>
        </div>
    </div>

    <!-- STT 텍스트 모달 -->
    <div id="sttTextModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>STT 변환: <span id="sttFileName"></span></h2>
                <button class="close-btn" onclick="closeSttTextModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <div class="audio-player">
                        <audio id="sttAudioPlayer" controls preload="metadata">
                            <source id="sttAudioSource" src="" type="audio/wav">
                            지원하지 않는 브라우저입니다.
                        </audio>
                    </div>
                </div>
                <div class="stt-text-content">
                    <textarea id="sttTextArea" class="stt-text-area" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 분석 상세 모달 (옵션 A) -->
    <div id="analysisDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>분석 상세: <span id="detailFileName"></span></h2>
                <button class="close-btn" onclick="closeAnalysisDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 위반사항 섹션 -->
                <div id="violationSection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: #333;">탐지된 위반사항</h3>
                    <div id="violationCards" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- 위반사항 카드가 여기에 동적으로 추가됩니다 -->
                    </div>
                </div>

                <!-- 오디오 플레이어 -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 10px; font-size: 18px; color: #333;">오디오</h3>
                    <div class="audio-player">
                        <audio id="detailAudioPlayer" controls preload="metadata" style="width: 100%;">
                            <source id="detailAudioSource1" src="" type="audio/wav">
                            <source id="detailAudioSource2" src="" type="audio/mp3">
                            <source id="detailAudioSource3" src="" type="audio/mpeg">
                            지원하지 않는 브라우저입니다.
                        </audio>
                    </div>
                </div>

                <!-- STT 전문 -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 10px; font-size: 18px; color: #333;">STT 전문</h3>
                    <div style="background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        <pre id="detailSttText" style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 14px; line-height: 1.6;"></pre>
                    </div>
                </div>

                <!-- 탐지된 키워드 -->
                <div id="keywordSection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 10px; font-size: 18px; color: #333;">탐지된 키워드</h3>
                    <div id="keywordBadges" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- 키워드 배지가 여기에 동적으로 추가됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 내보내기 형식 선택 모달 -->
    <div id="exportFormatModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>내보내기 형식 선택</h2>
                <button class="close-btn" onclick="closeExportFormatModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="btn btn-export" onclick="exportToExcel()" style="padding: 15px; font-size: 16px;">
                        Excel 파일 (.xlsx)
                    </button>
                    <button class="btn btn-export" onclick="exportToCSV()" style="padding: 15px; font-size: 16px;">
                        CSV 파일 (.csv)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        let currentJobId = null;
        let progressInterval = null;
        let currentFolderPath = null;
        let currentEmpId = null;
        let allResults = []; // Store all results for filtering
        let currentFilters = {
            status: 'all',
            risk: 'all'
        };
        let selectedFiles = new Set(); // Track selected filenames
        let currentIncludeClassification = false;
        let currentIncludeValidation = false;

        async function initPage() {
            // URL에서 job_id 추출
            const params = new URLSearchParams(window.location.search);
            currentJobId = params.get('job_id');

            if (!currentJobId) {
                showNotification('분석 작업 ID가 없습니다', 'error');
                setTimeout(() => window.location.href = '/upload', 2000);
                return;
            }

            // 사용자 정보 표시
            const sessionData = await apiCall('/api/auth/session', 'GET');
            if (sessionData && sessionData.emp_id) {
                currentEmpId = sessionData.emp_id;
                document.getElementById('userInfo').textContent = `${sessionData.name} (${sessionData.emp_id})`;
            }

            // 초기 진행률 확인
            checkProgress();

            // 2초마다 진행률 업데이트
            progressInterval = setInterval(checkProgress, 2000);
        }

        async function checkProgress() {
            try {
                const data = await apiCall(`/api/analysis/progress/${currentJobId}`, 'GET');
                
                if (!data) {
                    console.error('진행률 조회 실패');
                    return;
                }

                console.log('분석 진행 상황:', data);
                console.log('Results 데이터:', data.results);
                console.log('Results 개수:', data.results ? data.results.length : 0);

                // 폴더 정보 업데이트
                if (data.folder_path) {
                    currentFolderPath = data.folder_path;
                    document.getElementById('folderInfo').textContent = `폴더: ${data.folder_path}`;
                }

                // 진행률 업데이트
                const progress = data.progress || 0;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `${progress}% (${data.processed_files}/${data.total_files})`;
                
                // 현재 처리 중인 파일들 표시 (배열일 수 있음)
                if (data.current_file && data.current_file.length > 0) {
                    const currentFileEl = document.getElementById('currentFile');
                    if (currentFileEl) {
                        // current_file이 배열이므로 join으로 처리
                        const fileList = Array.isArray(data.current_file) ? data.current_file.join(', ') : data.current_file;
                        currentFileEl.textContent = `현재 처리: ${fileList}`;
                        currentFileEl.style.display = 'block';
                    }
                }

                // 통계 업데이트
                document.getElementById('totalFiles').textContent = data.total_files || 0;
                document.getElementById('completedFiles').textContent = data.processed_files || 0;
                
                // suspicious_count는 results에서 계산 - improper_detection_results의 detected_yn이 "Y"인 파일 카운트
                const suspiciousCount = (data.results || []).filter(r => {
                    if (!r.improper_detection_results) return false;
                    try {
                        const detectionData = typeof r.improper_detection_results === 'string' 
                            ? JSON.parse(r.improper_detection_results) 
                            : r.improper_detection_results;
                        return detectionData.detected_yn === 'Y';
                    } catch (e) {
                        console.error('Detection results 파싱 에러:', e);
                        return false;
                    }
                }).length;
                document.getElementById('suspiciousCount').textContent = suspiciousCount || 0;
                
                // 불완전판매 발견 카드 스타일 업데이트
                const suspiciousCard = document.getElementById('suspiciousCard');
                if (suspiciousCount > 0) {
                    suspiciousCard.classList.add('warning');
                } else {
                    suspiciousCard.classList.remove('warning');
                }

                // 상태별 UI 업데이트
                if (data.status === 'pending' || data.status === 'processing') {
                    document.getElementById('loadingSection').style.display = 'flex';
                    document.getElementById('completedSection').style.display = 'none';
                } else if (data.status === 'completed') {
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('completedSection').style.display = 'flex';
                    document.getElementById('completedText').textContent = `${data.total_files}개 파일 처리 완료`;
                    clearInterval(progressInterval);
                    showNotification('분석이 완료되었습니다', 'success');
                } else if (data.status === 'failed') {
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('completedSection').style.display = 'none';
                    showNotification('분석 중 오류가 발생했습니다', 'error');
                    clearInterval(progressInterval);
                }

                // ALWAYS render results (even if empty) for real-time updates
                renderResults(data.results || []);
            } catch (error) {
                console.error('진행률 조회 에러:', error);
            }
        }

        function renderResults(results) {
            console.log('renderResults 호출됨, results:', results);
            console.log('results 길이:', results ? results.length : 'null/undefined');
            
            // Store all results globally
            allResults = results || [];
            
            // Apply filters
            const filteredResults = applyFilters(allResults);
            console.log('filteredResults 길이:', filteredResults.length);
            
            // Update filter stats
            updateFilterStats(filteredResults.length, allResults.length);
            
            // Show filter section if we have results
            if (allResults.length > 0) {
                document.getElementById('filterSection').style.display = 'flex';
            }
            
            // Update selection UI (count, button state, etc.)
            updateSelectionUI();
            
            const tbody = document.getElementById('analysisTableBody');
            
            if (filteredResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">필터 조건에 맞는 결과가 없습니다</td></tr>';
                return;
            }

            // Map existing rows by filename for efficient lookup
            const existingRowsMap = new Map();
            Array.from(tbody.rows).forEach(row => {
                const fileCell = row.cells[2]; // filename column
                if (fileCell) {
                    existingRowsMap.set(fileCell.textContent.trim(), row);
                }
            });

            // Build new table body efficiently
            const newRows = [];
            filteredResults.forEach((result, index) => {
                const existingRow = existingRowsMap.get(result.filename);
                
                if (existingRow) {
                    // Update existing row (skip audio column to prevent flicker)
                    updateExistingRow(existingRow, result, index);
                    newRows.push(existingRow);
                    existingRowsMap.delete(result.filename);
                } else {
                    // Create new row
                    newRows.push(createNewRow(result, index));
                }
            });

            // Clear and append all rows
            tbody.innerHTML = '';
            newRows.forEach(row => tbody.appendChild(row));
        }

        function updateExistingRow(row, result, index) {
            const statusBadge = getStatusBadge(result.status);
            
            // Parse detection data
            let category = '-';
            let detectionResult = '-';
            let detectionBadgeClass = 'result-badge';
            
            if (result.status === 'completed' && result.improper_detection_results) {
                const detection = result.improper_detection_results;
                if (detection.category) category = detection.category;
                
                if (detection.detected_yn === 'Y') {
                    detectionResult = '위반 탐지';
                    detectionBadgeClass = 'result-badge result-danger';
                } else if (detection.detected_yn === 'N') {
                    detectionResult = '이상 없음';
                    detectionBadgeClass = 'result-badge result-safe';
                }
            }
            
            const detailButton = result.status === 'completed' 
                ? `<button onclick="showAnalysisDetail('${result.filename}')" class="btn-view">상세보기</button>` 
                : '-';
            
            // Update cells (skip index 3 which is audio)
            const isChecked = selectedFiles.has(result.filename) ? 'checked' : '';
            row.cells[0].innerHTML = `<input type="checkbox" class="file-checkbox" data-filename="${result.filename}" ${isChecked} onchange="handleFileCheckbox('${result.filename}', this.checked)">`;
            row.cells[1].textContent = index + 1;
            // cells[2] is filename - no need to update
            // cells[3] is audio - SKIP to prevent flicker
            row.cells[4].innerHTML = statusBadge;
            row.cells[5].textContent = category;
            row.cells[6].innerHTML = `<span class="${detectionBadgeClass}">${detectionResult}</span>`;
            row.cells[7].innerHTML = detailButton;
        }

        function createNewRow(result, index) {
            const statusBadge = getStatusBadge(result.status);
            
            // Parse detection data
            let category = '-';
            let detectionResult = '-';
            let detectionBadgeClass = 'result-badge';
            
            if (result.status === 'completed' && result.improper_detection_results) {
                const detection = result.improper_detection_results;
                if (detection.category) category = detection.category;
                
                if (detection.detected_yn === 'Y') {
                    detectionResult = '위반 탐지';
                    detectionBadgeClass = 'result-badge result-danger';
                } else if (detection.detected_yn === 'N') {
                    detectionResult = '이상 없음';
                    detectionBadgeClass = 'result-badge result-safe';
                }
            }
            
            const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(result.filename)}`;
            const isChecked = selectedFiles.has(result.filename) ? 'checked' : '';
            const detailButton = result.status === 'completed' 
                ? `<button onclick="showAnalysisDetail('${result.filename}')" class="btn-view">상세보기</button>` 
                : '-';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="checkbox-cell" style="text-align: center;">
                    <input type="checkbox" class="file-checkbox" data-filename="${result.filename}" ${isChecked} onchange="handleFileCheckbox('${result.filename}', this.checked)">
                </td>
                <td style="text-align: center;">${index + 1}</td>
                <td style="text-align: left;">${result.filename}</td>
                <td style="text-align: center;">
                    <div class="audio-player">
                        <audio controls preload="metadata">
                            <source src="${audioUrl}" type="audio/wav">
                            <source src="${audioUrl}" type="audio/mp3">
                            <source src="${audioUrl}" type="audio/mpeg">
                            지원하지 않는 브라우저입니다.
                        </audio>
                    </div>
                </td>
                <td style="text-align: center;">${statusBadge}</td>
                <td style="text-align: center;">${category}</td>
                <td style="text-align: center;"><span class="${detectionBadgeClass}">${detectionResult}</span></td>
                <td style="text-align: center;">${detailButton}</td>
            `;
            return row;
        }

        function applyFilters(results) {
            if (!results) return [];
            
            return results.filter(result => {
                // Status filter
                if (currentFilters.status !== 'all' && result.status !== currentFilters.status) {
                    return false;
                }
                
                // Risk filter - only apply if status is completed
                if (currentFilters.risk !== 'all') {
                    if (result.status !== 'completed') {
                        return false; // Hide non-completed files when filtering by risk
                    }
                    
                    // Check improper_detection_results to determine risk level
                    let actualRisk = 'safe'; // default
                    if (result.improper_detection_results) {
                        try {
                            const detectionData = typeof result.improper_detection_results === 'string' 
                                ? JSON.parse(result.improper_detection_results) 
                                : result.improper_detection_results;
                            if (detectionData.detected_yn === 'Y') {
                                actualRisk = 'danger';
                            }
                        } catch (e) {
                            console.error('Risk filter 파싱 에러:', e);
                        }
                    }
                    
                    if (actualRisk !== currentFilters.risk) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function updateFilterStats(filteredCount, totalCount) {
            document.getElementById('filteredCount').textContent = filteredCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function resetFilters() {
            currentFilters = { status: 'all', risk: 'all' };
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('riskFilter').value = 'all';
            renderResults(allResults);
        }

        // Setup filter event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const statusFilter = document.getElementById('statusFilter');
            const riskFilter = document.getElementById('riskFilter');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    currentFilters.status = e.target.value;
                    renderResults(allResults);
                });
            }
            
            if (riskFilter) {
                riskFilter.addEventListener('change', (e) => {
                    currentFilters.risk = e.target.value;
                    renderResults(allResults);
                });
            }
        });

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: '대기중', class: 'status-pending' },
                'processing': { text: '분석중', class: 'status-running' },
                'completed': { text: '완료', class: 'status-completed' },
                'failed': { text: '실패', class: 'status-error' }
            };

            const s = statusMap[status] || { text: status, class: 'status-pending' };
            return `<span class="status-badge ${s.class}">${s.text}</span>`;
        }

        function getRiskBadge(riskLevel) {
            // null이나 undefined인 경우 "-" 표시 (분석 전)
            if (!riskLevel) {
                return '<span class="result-badge result-safe">-</span>';
            }
            
            const riskMap = {
                'safe': { text: '이상 없음', class: 'result-safe' },
                'danger': { text: '위반 탐지', class: 'result-danger' }
            };

            // Only show mapped values, otherwise show "-"
            const r = riskMap[riskLevel];
            if (!r) {
                return '<span class="result-badge result-safe">-</span>';
            }
            return `<span class="result-badge ${r.class}">${r.text}</span>`;
        }

        function showSttContent(filename, content) {
            // 모달에 데이터 설정
            document.getElementById('sttFileName').textContent = filename;
            document.getElementById('sttTextArea').value = decodeURIComponent(content);
            
            // 오디오 플레이어 설정
            const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(filename)}`;
            const audioSource = document.getElementById('sttAudioSource');
            const audioPlayer = document.getElementById('sttAudioPlayer');
            audioSource.src = audioUrl;
            audioPlayer.load();
            
            // 모달 표시
            document.getElementById('sttTextModal').style.display = 'flex';
        }

        function closeSttTextModal() {
            document.getElementById('sttTextModal').style.display = 'none';
        }

        function showAnalysisDetail(filename) {
            // 현재 결과에서 해당 파일 찾기
            const result = allResults.find(r => r.filename === filename);
            if (!result || !result.improper_detection_results) {
                alert('분석 결과를 찾을 수 없습니다.');
                return;
            }

            const detection = result.improper_detection_results;
            
            // 파일명 설정
            document.getElementById('detailFileName').textContent = filename;
            
            // 오디오 플레이어 설정
            const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(filename)}`;
            const audioPlayer = document.getElementById('detailAudioPlayer');
            document.getElementById('detailAudioSource1').src = audioUrl;
            document.getElementById('detailAudioSource2').src = audioUrl;
            document.getElementById('detailAudioSource3').src = audioUrl;
            audioPlayer.load();
            
            // STT 전문 설정
            document.getElementById('detailSttText').textContent = result.stt_text || '(STT 데이터 없음)';
            
            // 위반사항 카드 생성
            const violationCards = document.getElementById('violationCards');
            const violationSection = document.getElementById('violationSection');
            
            if (detection.detected_yn === 'Y' && detection.detected_sentence && detection.detected_sentence.length > 0) {
                violationSection.style.display = 'block';
                violationCards.innerHTML = detection.detected_sentence.map((sentence, index) => {
                    const reason = detection.detected_reason && detection.detected_reason[index] 
                        ? detection.detected_reason[index] 
                        : '위반 사유 미제공';
                    
                    return `
                        <div style="background-color: #fff5f5; border-left: 4px solid #ef4444; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                <span style="background-color: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">위반 ${index + 1}</span>
                                <span style="color: #dc2626; font-weight: 500; font-size: 14px;">${reason}</span>
                            </div>
                            <div style="background-color: white; border: 1px solid #fee; border-radius: 6px; padding: 12px;">
                                <p style="margin: 0; color: #444; line-height: 1.6;">"${sentence}"</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                violationSection.style.display = 'block';
                violationCards.innerHTML = `
                    <div style="background-color: #f0fdf4; border-left: 4px solid #10b981; border-radius: 8px; padding: 15px; text-align: center;">
                        <span style="color: #059669; font-weight: 500; font-size: 16px;">위반사항이 탐지되지 않았습니다</span>
                    </div>
                `;
            }
            
            // 키워드 배지 생성
            const keywordBadges = document.getElementById('keywordBadges');
            const keywordSection = document.getElementById('keywordSection');
            
            if (detection.detected_keyword && detection.detected_keyword.length > 0) {
                keywordSection.style.display = 'block';
                keywordBadges.innerHTML = detection.detected_keyword.map(keyword => {
                    return `<span style="background-color: #3b82f6; color: white; padding: 6px 14px; border-radius: 16px; font-size: 13px; font-weight: 500;">${keyword}</span>`;
                }).join('');
            } else {
                keywordSection.style.display = 'none';
            }
            
            // 모달 표시
            document.getElementById('analysisDetailModal').style.display = 'flex';
        }

        function closeAnalysisDetailModal() {
            document.getElementById('analysisDetailModal').style.display = 'none';
        }

        function exportResults() {
            // 형식 선택 모달 표시
            document.getElementById('exportFormatModal').style.display = 'flex';
        }

        function closeExportFormatModal() {
            document.getElementById('exportFormatModal').style.display = 'none';
        }

        function exportToExcel() {
            try {
                closeExportFormatModal();
                
                // 필터링된 결과 사용
                const filteredResults = applyFilters(allResults);
                
                // Excel 워크북 생성
                const wb = XLSX.utils.book_new();
                
                // 데이터 배열 생성
                const wsData = [
                    ['번호', '파일명', 'STT 전문', '분석 상태', '카테고리', '분석 결과', '분석 내용 (Detected Sentence)', '분석 내용 (Detected Reason)', '분석 내용 (Detected Keyword)']
                ];
                
                // 각 결과를 행으로 추가
                filteredResults.forEach((result, index) => {
                    // status 매핑
                    const statusText = result.status === 'completed' ? '완료' : 
                                      result.status === 'pending' ? '대기중' : 
                                      result.status === 'processing' ? '분석중' : 
                                      result.status === 'failed' ? '실패' : '-';
                    
                    // improper_detection_results 파싱
                    let category = '-';
                    let detectionResult = '-';
                    let detectedSentences = '-';
                    let detectedReasons = '-';
                    let detectedKeywords = '-';
                    
                    if (result.status === 'completed' && result.improper_detection_results) {
                        try {
                            const detection = typeof result.improper_detection_results === 'string' 
                                ? JSON.parse(result.improper_detection_results) 
                                : result.improper_detection_results;
                            
                            // 카테고리
                            if (detection.category) {
                                category = detection.category;
                            }
                            
                            // 분석 결과
                            if (detection.detected_yn === 'Y') {
                                detectionResult = '위반 탐지';
                            } else if (detection.detected_yn === 'N') {
                                detectionResult = '이상 없음';
                            }
                            
                            // Detected Sentence
                            if (detection.detected_sentence && Array.isArray(detection.detected_sentence)) {
                                detectedSentences = detection.detected_sentence.join(' | ');
                            }
                            
                            // Detected Reason
                            if (detection.detected_reason && Array.isArray(detection.detected_reason)) {
                                detectedReasons = detection.detected_reason.join(' | ');
                            }
                            
                            // Detected Keyword
                            if (detection.detected_keyword && Array.isArray(detection.detected_keyword)) {
                                detectedKeywords = detection.detected_keyword.join(', ');
                            }
                        } catch (e) {
                            console.error('JSON 파싱 에러:', e);
                        }
                    }
                    
                    wsData.push([
                        index + 1,
                        result.filename || '',
                        result.stt_text || '-',
                        statusText,
                        category,
                        detectionResult,
                        detectedSentences,
                        detectedReasons,
                        detectedKeywords
                    ]);
                });
                
                // 워크시트 생성
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 열 너비 설정
                ws['!cols'] = [
                    { wch: 8 },   // 번호
                    { wch: 30 },  // 파일명
                    { wch: 80 },  // STT 전문
                    { wch: 12 },  // 분석 상태
                    { wch: 15 },  // 카테고리
                    { wch: 15 },  // 분석 결과
                    { wch: 50 },  // Detected Sentence
                    { wch: 50 },  // Detected Reason
                    { wch: 30 }   // Detected Keyword
                ];
                
                // 워크북에 워크시트 추가
                XLSX.utils.book_append_sheet(wb, ws, '분석결과');
                
                // Excel 파일 다운로드
                XLSX.writeFile(wb, `analysis_results_${currentFolderPath}_${new Date().toISOString().slice(0,10)}.xlsx`);
                
                showNotification('Excel 파일을 내보냈습니다', 'success');
            } catch (error) {
                console.error('Excel 내보내기 에러:', error);
                showNotification('Excel 내보내기에 실패했습니다', 'error');
            }
        }

        function exportToCSV() {
            try {
                closeExportFormatModal();
                
                // 필터링된 결과 사용
                const filteredResults = applyFilters(allResults);
                
                // CSV 데이터 생성
                const csvRows = [];
                
                // 헤더 추가
                csvRows.push(['번호', '파일명', 'STT 전문', '분석 상태', '카테고리', '분석 결과', '분석 내용 (Detected Sentence)', '분석 내용 (Detected Reason)', '분석 내용 (Detected Keyword)'].join(','));
                
                // 각 결과를 행으로 추가
                filteredResults.forEach((result, index) => {
                    // status 매핑
                    const statusText = result.status === 'completed' ? '완료' : 
                                      result.status === 'pending' ? '대기중' : 
                                      result.status === 'processing' ? '분석중' : 
                                      result.status === 'failed' ? '실패' : '-';
                    
                    // improper_detection_results 파싱
                    let category = '-';
                    let detectionResult = '-';
                    let detectedSentences = '-';
                    let detectedReasons = '-';
                    let detectedKeywords = '-';
                    
                    if (result.status === 'completed' && result.improper_detection_results) {
                        try {
                            const detection = typeof result.improper_detection_results === 'string' 
                                ? JSON.parse(result.improper_detection_results) 
                                : result.improper_detection_results;
                            
                            // 카테고리
                            if (detection.category) {
                                category = detection.category;
                            }
                            
                            // 분석 결과
                            if (detection.detected_yn === 'Y') {
                                detectionResult = '위반 탐지';
                            } else if (detection.detected_yn === 'N') {
                                detectionResult = '이상 없음';
                            }
                            
                            // Detected Sentence
                            if (detection.detected_sentence && Array.isArray(detection.detected_sentence)) {
                                detectedSentences = detection.detected_sentence.join(' | ');
                            }
                            
                            // Detected Reason
                            if (detection.detected_reason && Array.isArray(detection.detected_reason)) {
                                detectedReasons = detection.detected_reason.join(' | ');
                            }
                            
                            // Detected Keyword
                            if (detection.detected_keyword && Array.isArray(detection.detected_keyword)) {
                                detectedKeywords = detection.detected_keyword.join(', ');
                            }
                        } catch (e) {
                            console.error('JSON 파싱 에러:', e);
                        }
                    }
                    
                    const sttText = (result.stt_text || '-').replace(/"/g, '""');
                    const detectedSentencesEscaped = detectedSentences.replace(/"/g, '""');
                    const detectedReasonsEscaped = detectedReasons.replace(/"/g, '""');
                    const detectedKeywordsEscaped = detectedKeywords.replace(/"/g, '""');
                    
                    const row = [
                        index + 1,
                        `"${result.filename || ''}"`,
                        `"${sttText}"`,
                        statusText,
                        category,
                        detectionResult,
                        `"${detectedSentencesEscaped}"`,
                        `"${detectedReasonsEscaped}"`,
                        `"${detectedKeywordsEscaped}"`
                    ];
                    csvRows.push(row.join(','));
                });
                
                // CSV 파일 생성 및 다운로드
                const csvContent = '\uFEFF' + csvRows.join('\n'); // UTF-8 BOM 추가
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `analysis_results_${currentFolderPath}_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('CSV 파일을 내보냈습니다', 'success');
            } catch (error) {
                console.error('CSV 내보내기 에러:', error);
                showNotification('CSV 내보내기에 실패했습니다', 'error');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return encodeURIComponent(text);
        }

        function refreshProgress() {
            console.log('진행률 새로고침');
            checkProgress();
            showNotification('진행 상황을 새로고침했습니다', 'success');
        }

        function goBack() {
            window.location.href = '/upload';
        }

        async function logout() {
            try {
                const response = await apiCall('/api/auth/logout', 'POST');
                // API 호출 결과와 관계없이 로그인 페이지로 이동
                window.location.href = '/';
            } catch (error) {
                console.error('로그아웃 에러:', error);
                // 에러가 발생해도 로그인 페이지로 이동
                window.location.href = '/';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 분석 이력 모달 표시
        async function showHistoryModal() {
            try {
                // 현재 폴더 정보 가져오기
                const progressData = await apiCall(`/api/analysis/progress/${currentJobId}`, 'GET');
                if (!progressData) {
                    return;  // apiCall이 이미 에러 알림을 표시함
                }
                
                const currentFolder = progressData.folder_path || '';
                
                // 폴더 목록 로드
                const filesData = await apiCall('/api/files/folders', 'GET');
                if (!filesData) {
                    return;  // apiCall이 이미 에러 알림을 표시함
                }
                
                const folders = filesData.folders || [];
                
                // 폴더 선택지 채우기
                const folderSelect = document.getElementById('folderSelect');
                folderSelect.innerHTML = '<option value="">전체 폴더</option>' + 
                    folders.map(f => `<option value="${f}">${f}</option>`).join('');
                
                // 현재 폴더 선택
                if (currentFolder) {
                    folderSelect.value = currentFolder;
                }
                
                // 분석 이력 로드
                await loadAnalysisHistory(currentFolder);
                
                // 모달 표시
                document.getElementById('historyModal').style.display = 'flex';
                
                // 폴더 선택 변경 이벤트
                folderSelect.onchange = function() {
                    loadAnalysisHistory(this.value);
                };
            } catch (error) {
                console.error('분석 이력 모달 로드 실패:', error);
                showNotification('분석 이력 로드 실패', 'error');
            }
        }

        // 분석 이력 로드
        async function loadAnalysisHistory(folderPath) {
            try {
                const url = folderPath 
                    ? `/api/analysis/history?folder_path=${encodeURIComponent(folderPath)}`
                    : '/api/analysis/history';
                
                const response = await apiCall(url, 'GET');
                if (!response) {
                    return;  // apiCall이 이미 에러 알림을 표시함
                }
                
                const history = response.data || [];
                
                // 이력 목록 렌더링
                const historyListHtml = history.length > 0
                    ? history.map(job => `
                        <div class="history-item" onclick="viewAnalysis('${job.job_id}')">
                            <div class="history-item-info">
                                <div class="history-item-title">
                                    ${job.folder_path}
                                    <span class="history-item-badge ${getBadgeClass(job.status)}">${getStatusText(job.status)}</span>
                                </div>
                                <div class="history-item-meta">
                                    ${job.completed_files || 0} / ${job.total_files} 파일 완료
                                    | ${new Date(job.created_at).toLocaleString('ko-KR')}
                                </div>
                            </div>
                            <button class="btn btn-back" style="margin: 0;" onclick="event.stopPropagation(); viewAnalysis('${job.job_id}')">
                                보기
                            </button>
                        </div>
                    `).join('')
                    : '<div style="text-align: center; padding: 20px; color: #999;">분석 이력이 없습니다</div>';
                
                document.getElementById('historyList').innerHTML = historyListHtml;
            } catch (error) {
                console.error('분석 이력 조회 에러:', error);
                showNotification('분석 이력 조회 실패', 'error');
            }
        }

        // 분석 결과 보기
        function viewAnalysis(jobId) {
            window.location.href = `/analysis?job_id=${jobId}`;
        }

        // 모달 닫기
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // 상태 텍스트 변환
        function getStatusText(status) {
            const statusMap = {
                'pending': '대기중',
                'processing': '분석중',
                'completed': '완료',
                'failed': '실패'
            };
            return statusMap[status] || status;
        }

        // 상태별 배지 클래스
        function getBadgeClass(status) {
            const classMap = {
                'pending': 'badge-pending',
                'processing': 'badge-processing',
                'completed': 'badge-completed',
                'failed': 'badge-failed'
            };
            return classMap[status] || 'badge-pending';
        }

        // 페이지 로드
        document.addEventListener('DOMContentLoaded', async () => {
            await initPage();
        });

        // 모달 외부 클릭 시 닫기
        document.addEventListener('click', function(event) {
            const historyModal = document.getElementById('historyModal');
            const sttTextModal = document.getElementById('sttTextModal');
            const analysisDetailModal = document.getElementById('analysisDetailModal');
            
            if (event.target === historyModal) {
                closeHistoryModal();
            }
            if (event.target === sttTextModal) {
                closeSttTextModal();
            }
            if (event.target === analysisDetailModal) {
                closeAnalysisDetailModal();
            }
        });

        // ===== CHECKBOX AND RERUN FUNCTIONS =====

        function handleFileCheckbox(filename, isChecked) {
            if (isChecked) {
                selectedFiles.add(filename);
            } else {
                selectedFiles.delete(filename);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const filteredResults = applyFilters(allResults);
            
            if (checkbox.checked) {
                // Add all filtered files to selection
                filteredResults.forEach(result => {
                    selectedFiles.add(result.filename);
                });
            } else {
                // Remove all filtered files from selection
                filteredResults.forEach(result => {
                    selectedFiles.delete(result.filename);
                });
            }
            
            // Re-render to update checkbox states
            renderResults(allResults);
            updateSelectionUI();
        }

        function selectAllFiltered() {
            const filteredResults = applyFilters(allResults);
            filteredResults.forEach(result => {
                selectedFiles.add(result.filename);
            });
            renderResults(allResults);
            updateSelectionUI();
        }

        function deselectAll() {
            selectedFiles.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            renderResults(allResults);
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedFiles.size;
            
            // Update badge count in button
            const badgeElement = document.getElementById('selectedCountBadge');
            if (badgeElement) {
                badgeElement.textContent = count;
            }
            
            const rerunBtn = document.getElementById('rerunBtn');
            if (rerunBtn) {
                rerunBtn.disabled = count === 0;
            }
            
            // Update "select all" checkbox state
            const filteredResults = applyFilters(allResults);
            const allFilteredSelected = filteredResults.length > 0 && 
                filteredResults.every(r => selectedFiles.has(r.filename));
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allFilteredSelected;
            }
        }

        async function rerunSelectedFiles() {
            if (selectedFiles.size === 0) {
                showNotification('재실행할 파일을 선택하세요', 'warning');
                return;
            }
            
            const confirmed = confirm(`선택한 ${selectedFiles.size}개 파일을 재분석하시겠습니까?`);
            if (!confirmed) return;
            
            try {
                const selectedFilesArray = Array.from(selectedFiles);
                
                const response = await apiCall('/api/analysis/rerun', 'POST', {
                    job_id: currentJobId,
                    filenames: selectedFilesArray,
                    folder_path: currentFolderPath,
                    include_classification: currentIncludeClassification,
                    include_validation: currentIncludeValidation
                });
                
                if (response && response.success) {
                    showNotification(`재분석 시작: ${response.file_count}개 파일`, 'success');
                    
                    // Clear selection and stay on the same page
                    selectedFiles.clear();
                    updateSelectionUI();
                    
                    // Restart polling interval for real-time updates
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                    progressInterval = setInterval(checkProgress, 2000);
                    
                    // Force immediate progress check to see the reset files
                    setTimeout(() => {
                        checkProgress();
                    }, 500);
                } else {
                    showNotification('재분석 시작 실패', 'error');
                }
            } catch (error) {
                console.error('재분석 요청 에러:', error);
                showNotification('재분석 요청 중 오류 발생', 'error');
            }
        }
    </script>
</body>
</html>

