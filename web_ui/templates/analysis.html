<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶„ì„ ê²°ê³¼ - KIS ë¶ˆì™„ì „íŒë§¤ íƒì§€ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info #userInfo {
            font-size: 14px;
            font-weight: 500;
        }

        .btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .btn-refresh {
            background-color: #4CAF50;
        }

        .btn-refresh:hover {
            background-color: #45a049;
        }

        .btn-back {
            background-color: #2196F3;
        }

        .btn-back:hover {
            background-color: #0b7dda;
        }

        .btn-export {
            background-color: #10b981;
        }

        .btn-export:hover {
            background-color: #059669;
        }

        .btn-view {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-view:hover {
            background-color: #5568d3;
        }

        .container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .analysis-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .analysis-header h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .analysis-actions {
            display: flex;
            gap: 10px;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card.warning {
            background-color: #ffebee;
            border-left: 4px solid #c62828;
        }

        .stat-card.warning .stat-value {
            color: #c62828;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }



        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: #1976d2;
            color: white;
        }

        .status-running {
            background-color: #f57c00;
            color: white;
        }

        .status-completed {
            background-color: #388e3c;
            color: white;
        }

        .status-error {
            background-color: #c62828;
            color: white;
        }

        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .result-safe {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .result-warning {
            background-color: #fff3cd;
            color: #ff9800;
        }

        .result-danger {
            background-color: #ffebee;
            color: #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .status-banner {
            background-color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 50px;
            transition: all 0.3s ease;
        }

        .status-banner.processing {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
        }

        .status-banner.completed {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4CAF50;
        }

        .status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .status-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-text {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .status-progress-bar {
            flex: 1;
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            max-width: 300px;
        }

        .status-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .status-details {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }

        .loading-spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff9800;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 16px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .notification.error {
            background-color: #f44336;
        }

        .notification.warning {
            background-color: #ff9800;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background-color: #f5f5f5;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .history-item-meta {
            font-size: 12px;
            color: #999;
        }

        .history-item-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-processing {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-pending {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .badge-failed {
            background-color: #f8d7da;
            color: #721c24;
        }

        .stt-text-content {
            margin-top: 10px;
        }

        .stt-text-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .stt-text-area {
            width: 100%;
            min-height: 300px;
            max-height: 400px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            resize: none;
            background-color: #f8f9fa;
            overflow-y: auto;
        }

        .stt-text-area:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
        }

        .audio-player {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .audio-player audio {
            width: 100%;
            height: 32px;
            max-width: 250px;
        }

        .audio-player audio::-webkit-media-controls-panel {
            background-color: #f8f9fa;
        }

        /* Filter Section Styles */
        .filter-radio {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            background-color: white;
        }

        .filter-radio:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .filter-radio input[type="radio"] {
            display: none;
        }

        .filter-radio input[type="radio"]:checked + span {
            font-weight: bold;
        }

        .filter-radio:has(input[type="radio"]:checked) {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
        }

        .filter-radio.risk-safe:has(input[type="radio"]:checked) {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }

        .filter-radio.risk-warning:has(input[type="radio"]:checked) {
            background-color: #ff9800;
            border-color: #ff9800;
        }

        .filter-radio.risk-danger:has(input[type="radio"]:checked) {
            background-color: #f44336;
            border-color: #f44336;
        }

        #filterSection {
            border-left: 4px solid #667eea;
        }

        /* Checkbox selection styles */
        .checkbox-cell {
            text-align: center;
            padding: 8px;
        }

        .file-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .selection-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .selection-count {
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }

        .btn-rerun {
            background-color: #ff9800;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-rerun:hover:not(:disabled) {
            background-color: #f57c00;
        }

        .btn-rerun:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-select-all {
            background-color: #6c757d;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-select-all:hover {
            background-color: #5a6268;
        }

        /* Table control bar */
        .table-control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            border-radius: 8px 8px 0 0;
        }

        .btn-control {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .btn-control:hover {
            background-color: #5a6268;
        }

        .btn-control-rerun {
            background-color: #ff9800;
        }

        .btn-control-rerun:hover:not(:disabled) {
            background-color: #f57c00;
        }

        .btn-control-rerun:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .table-container table {
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>KIS ë¶ˆì™„ì „íŒë§¤ íƒì§€ ì‹œìŠ¤í…œ</h1>
        <div class="user-info">
            <span id="userInfo"></span>
            <button class="btn btn-refresh" onclick="refreshProgress()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-back" onclick="goBack()">â† ëŒì•„ê°€ê¸°</button>
            <button class="btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container">
        <!-- ë¶„ì„ ì •ë³´ -->
        <div class="analysis-header">
            <div>
                <h2>ë¶„ì„ ê²°ê³¼</h2>
                <p id="folderInfo" style="color: #666; font-size: 14px; margin-top: 8px;">í´ë”: ë¡œë”© ì¤‘...</p>
            </div>
            <div class="analysis-actions">
                <button class="btn btn-back" onclick="showHistoryModal()">ì´ì „ ë¶„ì„ ë³´ê¸°</button>
                <button class="btn btn-export" onclick="exportResults()">ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingSection" class="status-banner processing" style="display: none;">
            <div class="status-icon">
                <div class="loading-spinner-small"></div>
            </div>
            <div class="status-content">
                <span class="status-text">ë¶„ì„ ì¤‘...</span>
                <span class="status-details" id="currentFile" style="display: none; color: #666; font-size: 12px; margin-top: 5px;"></span>
                <div class="status-progress-bar">
                    <div class="status-progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <span class="status-details" id="progressText">0%</span>
            </div>
        </div>

        <!-- ì™„ë£Œ ìƒíƒœ -->
        <div id="completedSection" class="status-banner completed" style="display: none;">
            <div class="status-icon">âœ“</div>
            <div class="status-content">
                <span class="status-text">ë¶„ì„ ì™„ë£Œ!</span>
                <span class="status-details" id="completedText">ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ</span>
            </div>
        </div>

        <!-- í†µê³„ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">ì´ íŒŒì¼ ìˆ˜</div>
                <div class="stat-value" id="totalFiles">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ë¶„ì„ ì™„ë£Œ</div>
                <div class="stat-value" id="completedFiles">0</div>
            </div>
            <div class="stat-card" id="suspiciousCard">
                <div class="stat-label">ë¶€ë‹¹ê¶Œìœ  ë°œê²¬</div>
                <div class="stat-value" id="suspiciousCount">0</div>
            </div>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div id="filterSection" class="card" style="display: none; background-color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <!-- ë¶„ì„ìƒíƒœ í•„í„° -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px; white-space: nowrap;">ë¶„ì„ìƒíƒœ</label>
                    <label class="filter-radio">
                        <input type="radio" name="statusFilter" value="all" checked>
                        <span>ì „ì²´</span>
                    </label>
                    <label class="filter-radio">
                        <input type="radio" name="statusFilter" value="pending">
                        <span>ëŒ€ê¸°ì¤‘</span>
                    </label>
                    <label class="filter-radio">
                        <input type="radio" name="statusFilter" value="processing">
                        <span>ë¶„ì„ì¤‘</span>
                    </label>
                    <label class="filter-radio">
                        <input type="radio" name="statusFilter" value="completed">
                        <span>ì™„ë£Œ</span>
                    </label>
                    <label class="filter-radio">
                        <input type="radio" name="statusFilter" value="failed">
                        <span>ì‹¤íŒ¨</span>
                    </label>
                </div>
                
                <div style="height: 20px; width: 1px; background-color: #ddd;"></div>
                
                <!-- íŒë§¤íƒì§€ í•„í„° -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 600; color: #555; font-size: 14px; white-space: nowrap;">íŒë§¤íƒì§€</label>
                    <label class="filter-radio">
                        <input type="radio" name="riskFilter" value="all" checked>
                        <span>ì „ì²´</span>
                    </label>
                    <label class="filter-radio risk-safe">
                        <input type="radio" name="riskFilter" value="safe">
                        <span>ì •ìƒ</span>
                    </label>
                    <label class="filter-radio risk-warning">
                        <input type="radio" name="riskFilter" value="warning">
                        <span>ì˜ì‹¬</span>
                    </label>
                    <label class="filter-radio risk-danger">
                        <input type="radio" name="riskFilter" value="danger">
                        <span>ë¶€ë‹¹ê¶Œìœ </span>
                    </label>
                </div>
                
                <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 13px; color: #666; white-space: nowrap;">í‘œì‹œ: <strong id="filteredCount">0</strong> / <strong id="totalCount">0</strong>ê±´</span>
                    <button onclick="resetFilters()" class="btn" style="background-color: #6c757d; color: white; padding: 6px 12px; font-size: 13px; white-space: nowrap;">
                        í•„í„° ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ í…Œì´ë¸” -->
        <div class="table-container">
            <!-- í…Œì´ë¸” ì»¨íŠ¸ë¡¤ ë°” -->
            <div class="table-control-bar">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="selectAllFiltered()" class="btn-control">ì „ì²´ì„ íƒ</button>
                    <button onclick="deselectAll()" class="btn-control">ì„ íƒí•´ì œ</button>
                    <span class="selection-count">ì„ íƒ: <strong id="selectedCount">0</strong>ê°œ</span>
                </div>
                <button class="btn-control btn-control-rerun" id="rerunBtn" onclick="rerunSelectedFiles()" disabled>
                    ì„ íƒ íŒŒì¼ ì¬ì‹¤í–‰ (<span id="selectedCountBadge">0</span>)
                </button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th style="width: 4%">
                            <input type="checkbox" id="selectAllCheckbox" class="file-checkbox" onchange="toggleSelectAll()" style="visibility: hidden;">
                        </th>
                        <th style="width: 5%">ë²ˆí˜¸</th>
                        <th style="width: 18%">íŒŒì¼ëª…</th>
                        <th style="width: 22%">ì˜¤ë””ì˜¤</th>
                        <th style="width: 15%">STT ë³€í™˜</th>
                        <th style="width: 15%">ë¶„ì„ ìƒíƒœ</th>
                        <th style="width: 21%">íŒë§¤ íƒì§€</th>
                    </tr>
                </thead>
                <tbody id="analysisTableBody">
                    <tr>
                        <td colspan="6" class="empty-state">ë¶„ì„ ëŒ€ê¸° ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ë¶„ì„ ì´ë ¥ ëª¨ë‹¬ -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ë¶„ì„ ì´ë ¥</h2>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="folderSelector">
                    <label for="folderSelect" style="margin-bottom: 10px; display: block;">í´ë” ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                    <select id="folderSelect" style="width: 100%; padding: 8px; margin-bottom: 20px;">
                        <option value="">ì „ì²´ í´ë”</option>
                    </select>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
            <div class="modal-footer">
                <button class="action-button secondary-button" onclick="closeHistoryModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- STT í…ìŠ¤íŠ¸ ëª¨ë‹¬ -->
    <div id="sttTextModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>STT ë³€í™˜: <span id="sttFileName"></span></h2>
                <button class="close-btn" onclick="closeSttTextModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <div class="audio-player">
                        <audio id="sttAudioPlayer" controls preload="metadata">
                            <source id="sttAudioSource" src="" type="audio/wav">
                            ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.
                        </audio>
                    </div>
                </div>
                <div class="stt-text-content">
                    <textarea id="sttTextArea" class="stt-text-area" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let currentJobId = null;
        let progressInterval = null;
        let currentFolderPath = null;
        let currentEmpId = null;
        let allResults = []; // Store all results for filtering
        let currentFilters = {
            status: 'all',
            risk: 'all'
        };
        let selectedFiles = new Set(); // Track selected filenames
        let currentIncludeClassification = false;
        let currentIncludeValidation = false;

        async function initPage() {
            // URLì—ì„œ job_id ì¶”ì¶œ
            const params = new URLSearchParams(window.location.search);
            currentJobId = params.get('job_id');

            if (!currentJobId) {
                showNotification('ë¶„ì„ ì‘ì—… IDê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                setTimeout(() => window.location.href = '/upload', 2000);
                return;
            }

            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            const sessionData = await apiCall('/api/auth/session', 'GET');
            if (sessionData && sessionData.emp_id) {
                currentEmpId = sessionData.emp_id;
                document.getElementById('userInfo').textContent = `${sessionData.name} (${sessionData.emp_id})`;
            }

            // ì´ˆê¸° ì§„í–‰ë¥  í™•ì¸
            checkProgress();

            // 2ì´ˆë§ˆë‹¤ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            progressInterval = setInterval(checkProgress, 2000);
        }

        async function checkProgress() {
            try {
                const data = await apiCall(`/api/analysis/progress/${currentJobId}`, 'GET');
                
                if (!data) {
                    console.error('ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨');
                    return;
                }

                console.log('ë¶„ì„ ì§„í–‰ ìƒí™©:', data);
                console.log('Results ë°ì´í„°:', data.results);
                console.log('Results ê°œìˆ˜:', data.results ? data.results.length : 0);

                // í´ë” ì •ë³´ ì—…ë°ì´íŠ¸
                if (data.folder_path) {
                    currentFolderPath = data.folder_path;
                    document.getElementById('folderInfo').textContent = `í´ë”: ${data.folder_path}`;
                }

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                const progress = data.progress || 0;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `${progress}% (${data.processed_files}/${data.total_files})`;
                
                // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ íŒŒì¼ë“¤ í‘œì‹œ (ë°°ì—´ì¼ ìˆ˜ ìˆìŒ)
                if (data.current_file && data.current_file.length > 0) {
                    const currentFileEl = document.getElementById('currentFile');
                    if (currentFileEl) {
                        // current_fileì´ ë°°ì—´ì´ë¯€ë¡œ joinìœ¼ë¡œ ì²˜ë¦¬
                        const fileList = Array.isArray(data.current_file) ? data.current_file.join(', ') : data.current_file;
                        currentFileEl.textContent = `í˜„ì¬ ì²˜ë¦¬: ${fileList}`;
                        currentFileEl.style.display = 'block';
                    }
                }

                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalFiles').textContent = data.total_files || 0;
                document.getElementById('completedFiles').textContent = data.processed_files || 0;
                
                // suspicious_countëŠ” resultsì—ì„œ ê³„ì‚°
                const suspiciousCount = (data.results || []).filter(r => r.risk_level === 'danger').length;
                document.getElementById('suspiciousCount').textContent = suspiciousCount || 0;
                
                // ë¶€ë‹¹ê¶Œìœ  ë°œê²¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                const suspiciousCard = document.getElementById('suspiciousCard');
                if (suspiciousCount > 0) {
                    suspiciousCard.classList.add('warning');
                } else {
                    suspiciousCard.classList.remove('warning');
                }

                // ìƒíƒœë³„ UI ì—…ë°ì´íŠ¸
                if (data.status === 'pending' || data.status === 'processing') {
                    document.getElementById('loadingSection').style.display = 'flex';
                    document.getElementById('completedSection').style.display = 'none';
                } else if (data.status === 'completed') {
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('completedSection').style.display = 'flex';
                    document.getElementById('completedText').textContent = `${data.total_files}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ`;
                    clearInterval(progressInterval);
                    showNotification('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                } else if (data.status === 'failed') {
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('completedSection').style.display = 'none';
                    showNotification('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                    clearInterval(progressInterval);
                }

                // ALWAYS render results (even if empty) for real-time updates
                renderResults(data.results || []);
            } catch (error) {
                console.error('ì§„í–‰ë¥  ì¡°íšŒ ì—ëŸ¬:', error);
            }
        }

        function renderResults(results) {
            // Store all results globally
            allResults = results || [];
            
            // Apply filters
            const filteredResults = applyFilters(allResults);
            
            // Update filter stats
            updateFilterStats(filteredResults.length, allResults.length);
            
            // Show filter section if we have results
            if (allResults.length > 0) {
                document.getElementById('filterSection').style.display = 'block';
            }
            
            // Update selection UI (count, button state, etc.)
            updateSelectionUI();
            
            const tbody = document.getElementById('analysisTableBody');
            
            if (filteredResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">í•„í„° ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = filteredResults.map((result, index) => {
                const statusBadge = getStatusBadge(result.status);
                
                // Only show risk badge if status is 'completed'
                const riskBadge = result.status === 'completed' 
                    ? getRiskBadge(result.risk_level) 
                    : '<span class="result-badge" style="background-color: #f5f5f5; color: #999;">-</span>';
                
                // ì˜¤ë””ì˜¤ íŒŒì¼ ê²½ë¡œ êµ¬ì„±
                const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(result.filename)}`;
                const audioPlayer = `
                    <div class="audio-player">
                        <audio controls preload="metadata">
                            <source src="${audioUrl}" type="audio/wav">
                            <source src="${audioUrl}" type="audio/mp3">
                            <source src="${audioUrl}" type="audio/mpeg">
                            ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.
                        </audio>
                    </div>
                `;

                // Checkbox - checked if in selectedFiles Set
                const isChecked = selectedFiles.has(result.filename) ? 'checked' : '';
                const checkbox = `<input type="checkbox" class="file-checkbox" data-filename="${result.filename}" ${isChecked} onchange="handleFileCheckbox('${result.filename}', this.checked)">`;

                return `
                <tr>
                    <td class="checkbox-cell">${checkbox}</td>
                    <td>${index + 1}</td>
                    <td>${result.filename}</td>
                    <td>${audioPlayer}</td>
                    <td>
                        ${result.stt_text ? `<button onclick="showSttContent('${result.filename}', '${escapeHtml(result.stt_text)}')" class="btn-view">ë‚´ìš© ë³´ê¸°</button>` : '-'}
                    </td>
                    <td>${statusBadge}</td>
                    <td>${riskBadge}</td>
                </tr>
                `;
            }).join('');
        }

        function applyFilters(results) {
            if (!results) return [];
            
            return results.filter(result => {
                // Status filter
                if (currentFilters.status !== 'all' && result.status !== currentFilters.status) {
                    return false;
                }
                
                // Risk filter - only apply if status is completed
                if (currentFilters.risk !== 'all') {
                    if (result.status !== 'completed') {
                        return false; // Hide non-completed files when filtering by risk
                    }
                    if (result.risk_level !== currentFilters.risk) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function updateFilterStats(filteredCount, totalCount) {
            document.getElementById('filteredCount').textContent = filteredCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function resetFilters() {
            currentFilters = { status: 'all', risk: 'all' };
            document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
                radio.checked = radio.value === 'all';
            });
            document.querySelectorAll('input[name="riskFilter"]').forEach(radio => {
                radio.checked = radio.value === 'all';
            });
            renderResults(allResults);
        }

        // Setup filter event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentFilters.status = e.target.value;
                    renderResults(allResults);
                });
            });
            
            document.querySelectorAll('input[name="riskFilter"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentFilters.risk = e.target.value;
                    renderResults(allResults);
                });
            });
        });

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'ëŒ€ê¸°ì¤‘', class: 'status-pending' },
                'processing': { text: 'ë¶„ì„ì¤‘', class: 'status-running' },
                'completed': { text: 'ì™„ë£Œ', class: 'status-completed' },
                'failed': { text: 'ì‹¤íŒ¨', class: 'status-error' }
            };

            const s = statusMap[status] || { text: status, class: 'status-pending' };
            return `<span class="status-badge ${s.class}">${s.text}</span>`;
        }

        function getRiskBadge(riskLevel) {
            // nullì´ë‚˜ undefinedì¸ ê²½ìš° "-" í‘œì‹œ (ë¶„ì„ ì „)
            if (!riskLevel) {
                return '<span class="result-badge result-safe">-</span>';
            }
            
            const riskMap = {
                'safe': { text: 'ì •ìƒ', class: 'result-safe' },
                'warning': { text: 'ì˜ì‹¬', class: 'result-warning' },
                'danger': { text: 'ë¶€ë‹¹ê¶Œìœ  ë°œê²¬', class: 'result-danger' }
            };

            // Only show mapped values, otherwise show "-"
            const r = riskMap[riskLevel];
            if (!r) {
                return '<span class="result-badge result-safe">-</span>';
            }
            return `<span class="result-badge ${r.class}">${r.text}</span>`;
        }

        function showSttContent(filename, content) {
            // ëª¨ë‹¬ì— ë°ì´í„° ì„¤ì •
            document.getElementById('sttFileName').textContent = filename;
            document.getElementById('sttTextArea').value = decodeURIComponent(content);
            
            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì •
            const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(filename)}`;
            const audioSource = document.getElementById('sttAudioSource');
            const audioPlayer = document.getElementById('sttAudioPlayer');
            audioSource.src = audioUrl;
            audioPlayer.load();
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('sttTextModal').style.display = 'flex';
        }

        function closeSttTextModal() {
            document.getElementById('sttTextModal').style.display = 'none';
        }

        function exportResults() {
            try {
                const data = [];
                const tbody = document.getElementById('analysisTableBody');
                const rows = tbody.querySelectorAll('tr');
                
                // í—¤ë” ì¶”ê°€
                data.push(['ë²ˆí˜¸', 'íŒŒì¼ëª…', 'STT ë³€í™˜ í…ìŠ¤íŠ¸', 'ë¶„ì„ ìƒíƒœ', 'íŒë§¤ íƒì§€'].join(','));
                
                // ë°ì´í„° í–‰ ì¶”ê°€
                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        const rowData = [
                            cells[0].textContent.trim(),
                            `"${cells[1].textContent.trim()}"`,
                            `"${document.getElementById('sttTextArea')?.value || '-'}"`,
                            cells[4].textContent.trim(),
                            cells[5].textContent.trim()
                        ];
                        data.push(rowData.join(','));
                    }
                });
                
                // CSV íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                const csvContent = '\uFEFF' + data.join('\n'); // UTF-8 BOM ì¶”ê°€
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `analysis_results_${currentFolderPath}_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('ë¶„ì„ ê²°ê³¼ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('ê²°ê³¼ ë‚´ë³´ë‚´ê¸° ì—ëŸ¬:', error);
                showNotification('ê²°ê³¼ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return encodeURIComponent(text);
        }

        function refreshProgress() {
            console.log('ì§„í–‰ë¥  ìƒˆë¡œê³ ì¹¨');
            checkProgress();
            showNotification('ì§„í–‰ ìƒí™©ì„ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤', 'success');
        }

        function goBack() {
            window.location.href = '/upload';
        }

        async function logout() {
            try {
                const response = await apiCall('/api/auth/logout', 'POST');
                // API í˜¸ì¶œ ê²°ê³¼ì™€ ê´€ê³„ì—†ì´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = '/';
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:', error);
                // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = '/';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ë¶„ì„ ì´ë ¥ ëª¨ë‹¬ í‘œì‹œ
        async function showHistoryModal() {
            try {
                // í˜„ì¬ í´ë” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const progressData = await apiCall(`/api/analysis/progress/${currentJobId}`, 'GET');
                if (!progressData) {
                    return;  // apiCallì´ ì´ë¯¸ ì—ëŸ¬ ì•Œë¦¼ì„ í‘œì‹œí•¨
                }
                
                const currentFolder = progressData.folder_path || '';
                
                // í´ë” ëª©ë¡ ë¡œë“œ
                const filesData = await apiCall('/api/files/folders', 'GET');
                if (!filesData) {
                    return;  // apiCallì´ ì´ë¯¸ ì—ëŸ¬ ì•Œë¦¼ì„ í‘œì‹œí•¨
                }
                
                const folders = filesData.folders || [];
                
                // í´ë” ì„ íƒì§€ ì±„ìš°ê¸°
                const folderSelect = document.getElementById('folderSelect');
                folderSelect.innerHTML = '<option value="">ì „ì²´ í´ë”</option>' + 
                    folders.map(f => `<option value="${f}">${f}</option>`).join('');
                
                // í˜„ì¬ í´ë” ì„ íƒ
                if (currentFolder) {
                    folderSelect.value = currentFolder;
                }
                
                // ë¶„ì„ ì´ë ¥ ë¡œë“œ
                await loadAnalysisHistory(currentFolder);
                
                // ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('historyModal').style.display = 'flex';
                
                // í´ë” ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
                folderSelect.onchange = function() {
                    loadAnalysisHistory(this.value);
                };
            } catch (error) {
                console.error('ë¶„ì„ ì´ë ¥ ëª¨ë‹¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ë¶„ì„ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }

        // ë¶„ì„ ì´ë ¥ ë¡œë“œ
        async function loadAnalysisHistory(folderPath) {
            try {
                const url = folderPath 
                    ? `/api/analysis/history?folder_path=${encodeURIComponent(folderPath)}`
                    : '/api/analysis/history';
                
                const response = await apiCall(url, 'GET');
                if (!response) {
                    return;  // apiCallì´ ì´ë¯¸ ì—ëŸ¬ ì•Œë¦¼ì„ í‘œì‹œí•¨
                }
                
                const history = response.data || [];
                
                // ì´ë ¥ ëª©ë¡ ë Œë”ë§
                const historyListHtml = history.length > 0
                    ? history.map(job => `
                        <div class="history-item" onclick="viewAnalysis('${job.job_id}')">
                            <div class="history-item-info">
                                <div class="history-item-title">
                                    ${job.folder_path}
                                    <span class="history-item-badge ${getBadgeClass(job.status)}">${getStatusText(job.status)}</span>
                                </div>
                                <div class="history-item-meta">
                                    ${job.completed_files || 0} / ${job.total_files} íŒŒì¼ ì™„ë£Œ
                                    | ${new Date(job.created_at).toLocaleString('ko-KR')}
                                </div>
                            </div>
                            <button class="btn btn-back" style="margin: 0;" onclick="event.stopPropagation(); viewAnalysis('${job.job_id}')">
                                ë³´ê¸°
                            </button>
                        </div>
                    `).join('')
                    : '<div style="text-align: center; padding: 20px; color: #999;">ë¶„ì„ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                
                document.getElementById('historyList').innerHTML = historyListHtml;
            } catch (error) {
                console.error('ë¶„ì„ ì´ë ¥ ì¡°íšŒ ì—ëŸ¬:', error);
                showNotification('ë¶„ì„ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨', 'error');
            }
        }

        // ë¶„ì„ ê²°ê³¼ ë³´ê¸°
        function viewAnalysis(jobId) {
            window.location.href = `/analysis?job_id=${jobId}`;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'processing': 'ë¶„ì„ì¤‘',
                'completed': 'ì™„ë£Œ',
                'failed': 'ì‹¤íŒ¨'
            };
            return statusMap[status] || status;
        }

        // ìƒíƒœë³„ ë°°ì§€ í´ë˜ìŠ¤
        function getBadgeClass(status) {
            const classMap = {
                'pending': 'badge-pending',
                'processing': 'badge-processing',
                'completed': 'badge-completed',
                'failed': 'badge-failed'
            };
            return classMap[status] || 'badge-pending';
        }

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            await initPage();
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const historyModal = document.getElementById('historyModal');
            const sttTextModal = document.getElementById('sttTextModal');
            
            if (event.target === historyModal) {
                closeHistoryModal();
            }
            if (event.target === sttTextModal) {
                closeSttTextModal();
            }
        });

        // ===== CHECKBOX AND RERUN FUNCTIONS =====

        function handleFileCheckbox(filename, isChecked) {
            if (isChecked) {
                selectedFiles.add(filename);
            } else {
                selectedFiles.delete(filename);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const filteredResults = applyFilters(allResults);
            
            if (checkbox.checked) {
                // Add all filtered files to selection
                filteredResults.forEach(result => {
                    selectedFiles.add(result.filename);
                });
            } else {
                // Remove all filtered files from selection
                filteredResults.forEach(result => {
                    selectedFiles.delete(result.filename);
                });
            }
            
            // Re-render to update checkbox states
            renderResults(allResults);
            updateSelectionUI();
        }

        function selectAllFiltered() {
            const filteredResults = applyFilters(allResults);
            filteredResults.forEach(result => {
                selectedFiles.add(result.filename);
            });
            renderResults(allResults);
            updateSelectionUI();
        }

        function deselectAll() {
            selectedFiles.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            renderResults(allResults);
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedFiles.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectedCountBadge').textContent = count;
            
            const rerunBtn = document.getElementById('rerunBtn');
            rerunBtn.disabled = count === 0;
            
            // Update "select all" checkbox state
            const filteredResults = applyFilters(allResults);
            const allFilteredSelected = filteredResults.length > 0 && 
                filteredResults.every(r => selectedFiles.has(r.filename));
            document.getElementById('selectAllCheckbox').checked = allFilteredSelected;
        }

        async function rerunSelectedFiles() {
            if (selectedFiles.size === 0) {
                showNotification('ì¬ì‹¤í–‰í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'warning');
                return;
            }
            
            const confirmed = confirm(`ì„ íƒí•œ ${selectedFiles.size}ê°œ íŒŒì¼ì„ ì¬ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!confirmed) return;
            
            try {
                const selectedFilesArray = Array.from(selectedFiles);
                
                const response = await apiCall('/api/analysis/rerun', 'POST', {
                    job_id: currentJobId,
                    filenames: selectedFilesArray,
                    folder_path: currentFolderPath,
                    include_classification: currentIncludeClassification,
                    include_validation: currentIncludeValidation
                });
                
                if (response && response.success) {
                    showNotification(`ì¬ë¶„ì„ ì‹œì‘: ${response.file_count}ê°œ íŒŒì¼`, 'success');
                    
                    // Clear selection and stay on the same page
                    selectedFiles.clear();
                    updateSelectionUI();
                    
                    // Restart polling interval for real-time updates
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                    progressInterval = setInterval(checkProgress, 2000);
                    
                    // Force immediate progress check to see the reset files
                    setTimeout(() => {
                        checkProgress();
                    }, 500);
                } else {
                    showNotification('ì¬ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('ì¬ë¶„ì„ ìš”ì²­ ì—ëŸ¬:', error);
                showNotification('ì¬ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }
    </script>
</body>
</html>

