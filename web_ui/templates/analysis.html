<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶„ì„ ê²°ê³¼ - KIS ë¶ˆì™„ì „íŒë§¤ íƒì§€ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info #userInfo {
            font-size: 14px;
            font-weight: 500;
        }

        .btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .btn-refresh {
            background-color: #4CAF50;
        }

        .btn-refresh:hover {
            background-color: #45a049;
        }

        .btn-back {
            background-color: #2196F3;
        }

        .btn-back:hover {
            background-color: #0b7dda;
        }

        .btn-export {
            background-color: #667eea;
        }

        .btn-export:hover {
            background-color: #5568d3;
        }

        .btn-view {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-view:hover {
            background-color: #5568d3;
        }

        .container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .analysis-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .analysis-header h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .analysis-actions {
            display: flex;
            gap: 10px;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card.warning {
            background-color: #ffebee;
            border-left: 4px solid #c62828;
        }

        .stat-card.warning .stat-value {
            color: #c62828;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }



        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: #1976d2;
            color: white;
        }

        .status-running {
            background-color: #f57c00;
            color: white;
        }

        .status-completed {
            background-color: #388e3c;
            color: white;
        }

        .status-error {
            background-color: #c62828;
            color: white;
        }

        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .result-safe {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .result-warning {
            background-color: #fff3cd;
            color: #ff9800;
        }

        .result-danger {
            background-color: #ffebee;
            color: #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .status-banner {
            background-color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 50px;
            transition: all 0.3s ease;
        }

        .status-banner.processing {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
        }

        .status-banner.completed {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4CAF50;
        }

        .status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .status-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-text {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .status-progress-bar {
            flex: 1;
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            max-width: 300px;
        }

        .status-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .status-details {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }

        .loading-spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff9800;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            min-width: 250px;
            max-width: 400px;
        }

        .notification.success {
            background-color: #e8f5e9;
            color: #388e3c;
            border: 1px solid #388e3c;
        }

        .notification.error {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #d32f2f;
        }

        .notification.warning {
            background-color: #fff3e0;
            color: #f57c00;
            border: 1px solid #f57c00;
        }

        .notification.info {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #1976d2;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background-color: #f5f5f5;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .history-item-meta {
            font-size: 12px;
            color: #999;
        }

        .history-item-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-processing {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-pending {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .badge-failed {
            background-color: #f8d7da;
            color: #721c24;
        }

        .stt-text-content {
            margin-top: 10px;
        }

        .stt-text-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .stt-text-area {
            width: 100%;
            min-height: 300px;
            max-height: 400px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            resize: none;
            background-color: #f8f9fa;
            overflow-y: auto;
        }

        .stt-text-area:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
        }

        .audio-player {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .audio-player audio {
            width: 100%;
            height: 32px;
            max-width: 250px;
        }

        .audio-player audio::-webkit-media-controls-panel {
            background-color: #f8f9fa;
        }

        /* Checkbox selection styles */
        .checkbox-cell {
            text-align: center;
            padding: 8px;
        }

        .file-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .selection-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .selection-count {
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }

        .btn-rerun {
            background-color: #ff9800;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-rerun:hover:not(:disabled) {
            background-color: #f57c00;
        }

        .btn-rerun:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-select-all {
            background-color: #6c757d;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-select-all:hover {
            background-color: #5a6268;
        }

        /* Table control bar */
        .table-control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            border-radius: 8px 8px 0 0;
        }

        .btn-control {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .btn-control:hover {
            background-color: #5a6268;
        }

        .btn-control-rerun {
            background-color: #ff9800;
        }

        .btn-control-rerun:hover:not(:disabled) {
            background-color: #f57c00;
        }

        .btn-control-rerun:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .table-container table {
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>KIS ë¶ˆì™„ì „íŒë§¤ íƒì§€ ì‹œìŠ¤í…œ</h1>
        <div class="user-info">
            <span id="userInfo"></span>
            <button class="btn btn-back" onclick="goBack()">â† ëŒì•„ê°€ê¸°</button>
            <button class="btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container">
        <!-- ë¶„ì„ ì •ë³´ -->
        <div class="analysis-header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <h2 style="margin: 0;">ë¶„ì„ ê²°ê³¼</h2>
                <span style="color: #999; font-size: 20px; font-weight: 300;">|</span>
                <p id="folderInfo" style="color: #666; font-size: 20px; font-weight: 500; margin: 0;">í´ë”: ë¡œë”© ì¤‘...</p>
            </div>
            <div class="analysis-actions">
                <button class="btn btn-refresh" onclick="refreshProgress()">ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn btn-back" onclick="showHistoryModal()">ì´ì „ ë¶„ì„ ë³´ê¸°</button>
                <button class="btn btn-export" onclick="exportResults()">ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingSection" class="status-banner processing" style="display: none;">
            <div class="status-icon">
                <div class="loading-spinner-small"></div>
            </div>
            <div class="status-content">
                <span class="status-text">ë¶„ì„ ì¤‘...</span>
                <span class="status-details" id="currentFile" style="display: none; color: #666; font-size: 12px; margin-top: 5px;"></span>
                <div class="status-progress-bar">
                    <div class="status-progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <span class="status-details" id="progressText">0%</span>
            </div>
        </div>

        <!-- ì™„ë£Œ ìƒíƒœ -->
        <div id="completedSection" class="status-banner completed" style="display: none;">
            <div class="status-icon">âœ“</div>
            <div class="status-content">
                <span class="status-text">ë¶„ì„ ì™„ë£Œ!</span>
                <span class="status-details" id="completedText">ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ</span>
            </div>
        </div>

        <!-- í†µê³„ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">ì´ íŒŒì¼</div>
                <div class="stat-value" id="totalFiles">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ë¶„ì„ ì™„ë£Œ</div>
                <div class="stat-value" id="completedFiles">0</div>
            </div>
            <div class="stat-card" id="suspiciousCard">
                <div class="stat-label">ë¶ˆì™„ì „íŒë§¤ íƒì§€</div>
                <div class="stat-value" id="suspiciousCount">0</div>
            </div>
        </div>

        <!-- ê²°ê³¼ í…Œì´ë¸” -->
        <div class="table-container">
            <!-- í…Œì´ë¸” ì»¨íŠ¸ë¡¤ ë°” with í•„í„° -->
            <div class="table-control-bar" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; flex-wrap: wrap; gap: 16px;">
                <!-- ì¢Œì¸¡: ì„ íƒ ì»¨íŠ¸ë¡¤ -->
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-control btn-control-rerun" id="rerunBtn" onclick="rerunSelectedFiles()" disabled style="padding: 6px 14px; font-size: 13px;">
                        ì„ íƒ íŒŒì¼ ì¬ì‹¤í–‰ (<span id="selectedCountBadge">0</span>)
                    </button>
                </div>
                
                <!-- ìš°ì¸¡: í•„í„° ì˜ì—­ -->
                <div id="filterSection" style="display: none; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <!-- ë¶„ì„ìƒíƒœ í•„í„° -->
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <label style="font-weight: 600; color: #555; font-size: 13px; white-space: nowrap;">ë¶„ì„ìƒíƒœ</label>
                        <select id="statusFilter" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; background-color: white;">
                            <option value="all">ì „ì²´</option>
                            <option value="pending">ëŒ€ê¸°ì¤‘</option>
                            <option value="processing">ë¶„ì„ì¤‘</option>
                            <option value="completed">ì™„ë£Œ</option>
                            <option value="failed">ì‹¤íŒ¨</option>
                        </select>
                    </div>
                    
                    <div style="height: 20px; width: 1px; background-color: #ccc;"></div>
                    
                    <!-- ë¶„ì„ ê²°ê³¼ í•„í„° -->
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <label style="font-weight: 600; color: #555; font-size: 13px; white-space: nowrap;">ë¶„ì„ ê²°ê³¼</label>
                        <select id="riskFilter" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; background-color: white;">
                            <option value="all">ì „ì²´</option>
                            <option value="safe">ì´ìƒ ì—†ìŒ</option>
                            <option value="danger">ìœ„ë°˜ íƒì§€</option>
                        </select>
                    </div>
                    
                    <div style="height: 20px; width: 1px; background-color: #ccc;"></div>
                    
                    <!-- í•„í„° í†µê³„ ë° ë¦¬ì…‹ -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: #666; white-space: nowrap;">í‘œì‹œ: <strong id="filteredCount">0</strong>/<strong id="totalCount">0</strong></span>
                        <button onclick="resetFilters()" class="btn" style="background-color: #6c757d; color: white; padding: 6px 14px; font-size: 13px; white-space: nowrap; border: none; border-radius: 4px; cursor: pointer;">
                            í•„í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th style="width: 4%; text-align: center;">
                            <input type="checkbox" id="selectAllCheckbox" class="file-checkbox" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 5%; text-align: center;">ë²ˆí˜¸</th>
                        <th style="width: 18%; text-align: left;">íŒŒì¼ëª…</th>
                        <th style="width: 20%; text-align: left;">ì˜¤ë””ì˜¤</th>
                        <th style="width: 12%; text-align: center;">ë¶„ì„ ìƒíƒœ</th>
                        <th style="width: 10%; text-align: center;">ì¹´í…Œê³ ë¦¬</th>
                        <th style="width: 12%; text-align: center;">ë¶„ì„ ê²°ê³¼</th>
                        <th style="width: 10%; text-align: center;">ë¶„ì„ ë‚´ìš©</th>
                    </tr>
                </thead>
                <tbody id="analysisTableBody">
                    <tr>
                        <td colspan="8" class="empty-state">ë¶„ì„ ëŒ€ê¸° ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ë¶„ì„ ì´ë ¥ ëª¨ë‹¬ -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ë¶„ì„ ì´ë ¥</h2>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="folderSelector">
                    <label for="folderSelect" style="margin-bottom: 10px; display: block;">í´ë” ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                    <select id="folderSelect" style="width: 100%; padding: 8px; margin-bottom: 20px;">
                        <option value="">ì „ì²´ í´ë”</option>
                    </select>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
            <div class="modal-footer">
                <button class="action-button secondary-button" onclick="closeHistoryModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- STT í…ìŠ¤íŠ¸ ëª¨ë‹¬ -->
    <div id="sttTextModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>STT ë³€í™˜: <span id="sttFileName"></span></h2>
                <button class="close-btn" onclick="closeSttTextModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <div class="audio-player">
                        <audio id="sttAudioPlayer" controls preload="metadata">
                            <source id="sttAudioSource" src="" type="audio/wav">
                            ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.
                        </audio>
                    </div>
                </div>
                <div class="stt-text-content">
                    <textarea id="sttTextArea" class="stt-text-area" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¶„ì„ ìƒì„¸ ëª¨ë‹¬ (ì˜µì…˜ A) -->
    <div id="analysisDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>ë¶„ì„ ìƒì„¸: <span id="detailFileName"></span></h2>
                <button class="close-btn" onclick="closeAnalysisDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- ìœ„ë°˜ì‚¬í•­ ì„¹ì…˜ -->
                <div id="violationSection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: #333;">ğŸš¨ íƒì§€ëœ ìœ„ë°˜ì‚¬í•­</h3>
                    <div id="violationCards" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- ìœ„ë°˜ì‚¬í•­ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 10px; font-size: 18px; color: #333;">ğŸµ ì˜¤ë””ì˜¤</h3>
                    <div class="audio-player">
                        <audio id="detailAudioPlayer" controls preload="metadata" style="width: 100%;">
                            <source id="detailAudioSource1" src="" type="audio/wav">
                            <source id="detailAudioSource2" src="" type="audio/mp3">
                            <source id="detailAudioSource3" src="" type="audio/mpeg">
                            ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.
                        </audio>
                    </div>
                </div>

                <!-- STT ì „ë¬¸ -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 10px; font-size: 18px; color: #333;">ğŸ“ STT ì „ë¬¸</h3>
                    <div style="background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        <pre id="detailSttText" style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 14px; line-height: 1.6;"></pre>
                    </div>
                </div>

                <!-- íƒì§€ëœ í‚¤ì›Œë“œ -->
                <div id="keywordSection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 10px; font-size: 18px; color: #333;">ğŸ” íƒì§€ëœ í‚¤ì›Œë“œ</h3>
                    <div id="keywordBadges" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- í‚¤ì›Œë“œ ë°°ì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‚´ë³´ë‚´ê¸° í˜•ì‹ ì„ íƒ ëª¨ë‹¬ -->
    <div id="exportFormatModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>ë‚´ë³´ë‚´ê¸° í˜•ì‹ ì„ íƒ</h2>
                <button class="close-btn" onclick="closeExportFormatModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="btn btn-export" onclick="exportToExcel()" style="padding: 15px; font-size: 16px;">
                        ğŸ“Š Excel íŒŒì¼ (.xlsx)
                    </button>
                    <button class="btn btn-export" onclick="exportToCSV()" style="padding: 15px; font-size: 16px;">
                        ğŸ“„ CSV íŒŒì¼ (.csv)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        let currentJobId = null;
        let progressInterval = null;
        let currentFolderPath = null;
        let currentEmpId = null;
        let allResults = []; // Store all results for filtering
        let currentFilters = {
            status: 'all',
            risk: 'all'
        };
        let selectedFiles = new Set(); // Track selected filenames
        let currentIncludeClassification = false;
        let currentIncludeValidation = false;

        async function initPage() {
            // URLì—ì„œ job_id ì¶”ì¶œ
            const params = new URLSearchParams(window.location.search);
            currentJobId = params.get('job_id');

            if (!currentJobId) {
                showNotification('ë¶„ì„ ì‘ì—… IDê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                setTimeout(() => window.location.href = '/upload', 2000);
                return;
            }

            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            const sessionData = await apiCall('/api/auth/session', 'GET');
            if (sessionData && sessionData.emp_id) {
                currentEmpId = sessionData.emp_id;
                document.getElementById('userInfo').textContent = `${sessionData.name} (${sessionData.emp_id})`;
            }

            // ì´ˆê¸° ì§„í–‰ë¥  í™•ì¸
            checkProgress();

            // 2ì´ˆë§ˆë‹¤ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            progressInterval = setInterval(checkProgress, 2000);
        }

        async function checkProgress() {
            try {
                const data = await apiCall(`/api/analysis/progress/${currentJobId}`, 'GET');
                
                if (!data) {
                    console.error('ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨');
                    return;
                }

                console.log('ë¶„ì„ ì§„í–‰ ìƒí™©:', data);
                console.log('Results ë°ì´í„°:', data.results);
                console.log('Results ê°œìˆ˜:', data.results ? data.results.length : 0);

                // í´ë” ì •ë³´ ì—…ë°ì´íŠ¸
                if (data.folder_path) {
                    currentFolderPath = data.folder_path;
                    document.getElementById('folderInfo').textContent = `í´ë”: ${data.folder_path}`;
                }

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                const progress = data.progress || 0;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `${progress}% (${data.processed_files}/${data.total_files})`;
                
                // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ íŒŒì¼ë“¤ í‘œì‹œ (ë°°ì—´ì¼ ìˆ˜ ìˆìŒ)
                if (data.current_file && data.current_file.length > 0) {
                    const currentFileEl = document.getElementById('currentFile');
                    if (currentFileEl) {
                        // current_fileì´ ë°°ì—´ì´ë¯€ë¡œ joinìœ¼ë¡œ ì²˜ë¦¬
                        const fileList = Array.isArray(data.current_file) ? data.current_file.join(', ') : data.current_file;
                        currentFileEl.textContent = `í˜„ì¬ ì²˜ë¦¬: ${fileList}`;
                        currentFileEl.style.display = 'block';
                    }
                }

                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalFiles').textContent = data.total_files || 0;
                document.getElementById('completedFiles').textContent = data.processed_files || 0;
                
                // suspicious_countëŠ” resultsì—ì„œ ê³„ì‚° - improper_detection_resultsì˜ detected_ynì´ "Y"ì¸ íŒŒì¼ ì¹´ìš´íŠ¸
                const suspiciousCount = (data.results || []).filter(r => {
                    if (!r.improper_detection_results) return false;
                    try {
                        const detectionData = typeof r.improper_detection_results === 'string' 
                            ? JSON.parse(r.improper_detection_results) 
                            : r.improper_detection_results;
                        return detectionData.detected_yn === 'Y';
                    } catch (e) {
                        console.error('Detection results íŒŒì‹± ì—ëŸ¬:', e);
                        return false;
                    }
                }).length;
                document.getElementById('suspiciousCount').textContent = suspiciousCount || 0;
                
                // ë¶ˆì™„ì „íŒë§¤ ë°œê²¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                const suspiciousCard = document.getElementById('suspiciousCard');
                if (suspiciousCount > 0) {
                    suspiciousCard.classList.add('warning');
                } else {
                    suspiciousCard.classList.remove('warning');
                }

                // ìƒíƒœë³„ UI ì—…ë°ì´íŠ¸
                if (data.status === 'pending' || data.status === 'processing') {
                    document.getElementById('loadingSection').style.display = 'flex';
                    document.getElementById('completedSection').style.display = 'none';
                } else if (data.status === 'completed') {
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('completedSection').style.display = 'flex';
                    document.getElementById('completedText').textContent = `${data.total_files}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ`;
                    clearInterval(progressInterval);
                    showNotification('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                } else if (data.status === 'failed') {
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('completedSection').style.display = 'none';
                    showNotification('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                    clearInterval(progressInterval);
                }

                // ALWAYS render results (even if empty) for real-time updates
                renderResults(data.results || []);
            } catch (error) {
                console.error('ì§„í–‰ë¥  ì¡°íšŒ ì—ëŸ¬:', error);
            }
        }

        function renderResults(results) {
            console.log('renderResults í˜¸ì¶œë¨, results:', results);
            console.log('results ê¸¸ì´:', results ? results.length : 'null/undefined');
            
            // Store all results globally
            allResults = results || [];
            
            // Apply filters
            const filteredResults = applyFilters(allResults);
            console.log('filteredResults ê¸¸ì´:', filteredResults.length);
            
            // Update filter stats
            updateFilterStats(filteredResults.length, allResults.length);
            
            // Show filter section if we have results
            if (allResults.length > 0) {
                document.getElementById('filterSection').style.display = 'flex';
            }
            
            // Update selection UI (count, button state, etc.)
            updateSelectionUI();
            
            const tbody = document.getElementById('analysisTableBody');
            
            if (filteredResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">í•„í„° ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            // Map existing rows by filename for efficient lookup
            const existingRowsMap = new Map();
            Array.from(tbody.rows).forEach(row => {
                const fileCell = row.cells[2]; // filename column
                if (fileCell) {
                    existingRowsMap.set(fileCell.textContent.trim(), row);
                }
            });

            // Build new table body efficiently
            const newRows = [];
            filteredResults.forEach((result, index) => {
                const existingRow = existingRowsMap.get(result.filename);
                
                if (existingRow) {
                    // Update existing row (skip audio column to prevent flicker)
                    updateExistingRow(existingRow, result, index);
                    newRows.push(existingRow);
                    existingRowsMap.delete(result.filename);
                } else {
                    // Create new row
                    newRows.push(createNewRow(result, index));
                }
            });

            // Clear and append all rows
            tbody.innerHTML = '';
            newRows.forEach(row => tbody.appendChild(row));
        }

        function updateExistingRow(row, result, index) {
            const statusBadge = getStatusBadge(result.status);
            
            // Parse detection data
            let category = '-';
            let detectionResult = '-';
            let detectionBadgeClass = 'result-badge';
            
            if (result.status === 'completed' && result.improper_detection_results) {
                const detection = result.improper_detection_results;
                if (detection.category) category = detection.category;
                
                if (detection.detected_yn === 'Y') {
                    detectionResult = 'ìœ„ë°˜ íƒì§€';
                    detectionBadgeClass = 'result-badge result-danger';
                } else if (detection.detected_yn === 'N') {
                    detectionResult = 'ì´ìƒ ì—†ìŒ';
                    detectionBadgeClass = 'result-badge result-safe';
                }
            }
            
            const detailButton = result.status === 'completed' 
                ? `<button onclick="showAnalysisDetail('${result.filename}')" class="btn-view">ìƒì„¸ë³´ê¸°</button>` 
                : '-';
            
            // Update cells (skip index 3 which is audio)
            const isChecked = selectedFiles.has(result.filename) ? 'checked' : '';
            row.cells[0].innerHTML = `<input type="checkbox" class="file-checkbox" data-filename="${result.filename}" ${isChecked} onchange="handleFileCheckbox('${result.filename}', this.checked)">`;
            row.cells[1].textContent = index + 1;
            // cells[2] is filename - no need to update
            // cells[3] is audio - SKIP to prevent flicker
            row.cells[4].innerHTML = statusBadge;
            row.cells[5].textContent = category;
            row.cells[6].innerHTML = `<span class="${detectionBadgeClass}">${detectionResult}</span>`;
            row.cells[7].innerHTML = detailButton;
        }

        function createNewRow(result, index) {
            const statusBadge = getStatusBadge(result.status);
            
            // Parse detection data
            let category = '-';
            let detectionResult = '-';
            let detectionBadgeClass = 'result-badge';
            
            if (result.status === 'completed' && result.improper_detection_results) {
                const detection = result.improper_detection_results;
                if (detection.category) category = detection.category;
                
                if (detection.detected_yn === 'Y') {
                    detectionResult = 'ìœ„ë°˜ íƒì§€';
                    detectionBadgeClass = 'result-badge result-danger';
                } else if (detection.detected_yn === 'N') {
                    detectionResult = 'ì´ìƒ ì—†ìŒ';
                    detectionBadgeClass = 'result-badge result-safe';
                }
            }
            
            const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(result.filename)}`;
            const isChecked = selectedFiles.has(result.filename) ? 'checked' : '';
            const detailButton = result.status === 'completed' 
                ? `<button onclick="showAnalysisDetail('${result.filename}')" class="btn-view">ìƒì„¸ë³´ê¸°</button>` 
                : '-';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="checkbox-cell" style="text-align: center;">
                    <input type="checkbox" class="file-checkbox" data-filename="${result.filename}" ${isChecked} onchange="handleFileCheckbox('${result.filename}', this.checked)">
                </td>
                <td style="text-align: center;">${index + 1}</td>
                <td style="text-align: left;">${result.filename}</td>
                <td style="text-align: center;">
                    <div class="audio-player">
                        <audio controls preload="metadata">
                            <source src="${audioUrl}" type="audio/wav">
                            <source src="${audioUrl}" type="audio/mp3">
                            <source src="${audioUrl}" type="audio/mpeg">
                            ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.
                        </audio>
                    </div>
                </td>
                <td style="text-align: center;">${statusBadge}</td>
                <td style="text-align: center;">${category}</td>
                <td style="text-align: center;"><span class="${detectionBadgeClass}">${detectionResult}</span></td>
                <td style="text-align: center;">${detailButton}</td>
            `;
            return row;
        }

        function applyFilters(results) {
            if (!results) return [];
            
            return results.filter(result => {
                // Status filter
                if (currentFilters.status !== 'all' && result.status !== currentFilters.status) {
                    return false;
                }
                
                // Risk filter - only apply if status is completed
                if (currentFilters.risk !== 'all') {
                    if (result.status !== 'completed') {
                        return false; // Hide non-completed files when filtering by risk
                    }
                    
                    // Check improper_detection_results to determine risk level
                    let actualRisk = 'safe'; // default
                    if (result.improper_detection_results) {
                        try {
                            const detectionData = typeof result.improper_detection_results === 'string' 
                                ? JSON.parse(result.improper_detection_results) 
                                : result.improper_detection_results;
                            if (detectionData.detected_yn === 'Y') {
                                actualRisk = 'danger';
                            }
                        } catch (e) {
                            console.error('Risk filter íŒŒì‹± ì—ëŸ¬:', e);
                        }
                    }
                    
                    if (actualRisk !== currentFilters.risk) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function updateFilterStats(filteredCount, totalCount) {
            document.getElementById('filteredCount').textContent = filteredCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function resetFilters() {
            currentFilters = { status: 'all', risk: 'all' };
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('riskFilter').value = 'all';
            renderResults(allResults);
        }

        // Setup filter event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const statusFilter = document.getElementById('statusFilter');
            const riskFilter = document.getElementById('riskFilter');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    currentFilters.status = e.target.value;
                    renderResults(allResults);
                });
            }
            
            if (riskFilter) {
                riskFilter.addEventListener('change', (e) => {
                    currentFilters.risk = e.target.value;
                    renderResults(allResults);
                });
            }
        });

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'ëŒ€ê¸°ì¤‘', class: 'status-pending' },
                'processing': { text: 'ë¶„ì„ì¤‘', class: 'status-running' },
                'completed': { text: 'ì™„ë£Œ', class: 'status-completed' },
                'failed': { text: 'ì‹¤íŒ¨', class: 'status-error' }
            };

            const s = statusMap[status] || { text: status, class: 'status-pending' };
            return `<span class="status-badge ${s.class}">${s.text}</span>`;
        }

        function getRiskBadge(riskLevel) {
            // nullì´ë‚˜ undefinedì¸ ê²½ìš° "-" í‘œì‹œ (ë¶„ì„ ì „)
            if (!riskLevel) {
                return '<span class="result-badge result-safe">-</span>';
            }
            
            const riskMap = {
                'safe': { text: 'ì´ìƒ ì—†ìŒ', class: 'result-safe' },
                'danger': { text: 'ìœ„ë°˜ íƒì§€', class: 'result-danger' }
            };

            // Only show mapped values, otherwise show "-"
            const r = riskMap[riskLevel];
            if (!r) {
                return '<span class="result-badge result-safe">-</span>';
            }
            return `<span class="result-badge ${r.class}">${r.text}</span>`;
        }

        function showSttContent(filename, content) {
            // ëª¨ë‹¬ì— ë°ì´í„° ì„¤ì •
            document.getElementById('sttFileName').textContent = filename;
            document.getElementById('sttTextArea').value = decodeURIComponent(content);
            
            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì •
            const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(filename)}`;
            const audioSource = document.getElementById('sttAudioSource');
            const audioPlayer = document.getElementById('sttAudioPlayer');
            audioSource.src = audioUrl;
            audioPlayer.load();
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('sttTextModal').style.display = 'flex';
        }

        function closeSttTextModal() {
            document.getElementById('sttTextModal').style.display = 'none';
        }

        function showAnalysisDetail(filename) {
            // í˜„ì¬ ê²°ê³¼ì—ì„œ í•´ë‹¹ íŒŒì¼ ì°¾ê¸°
            const result = allResults.find(r => r.filename === filename);
            if (!result || !result.improper_detection_results) {
                alert('ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const detection = result.improper_detection_results;
            
            // íŒŒì¼ëª… ì„¤ì •
            document.getElementById('detailFileName').textContent = filename;
            
            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì •
            const audioUrl = `/api/files/audio/${currentEmpId}/${currentFolderPath}/${encodeURIComponent(filename)}`;
            const audioPlayer = document.getElementById('detailAudioPlayer');
            document.getElementById('detailAudioSource1').src = audioUrl;
            document.getElementById('detailAudioSource2').src = audioUrl;
            document.getElementById('detailAudioSource3').src = audioUrl;
            audioPlayer.load();
            
            // STT ì „ë¬¸ ì„¤ì •
            document.getElementById('detailSttText').textContent = result.stt_text || '(STT ë°ì´í„° ì—†ìŒ)';
            
            // ìœ„ë°˜ì‚¬í•­ ì¹´ë“œ ìƒì„±
            const violationCards = document.getElementById('violationCards');
            const violationSection = document.getElementById('violationSection');
            
            if (detection.detected_yn === 'Y' && detection.detected_sentence && detection.detected_sentence.length > 0) {
                violationSection.style.display = 'block';
                violationCards.innerHTML = detection.detected_sentence.map((sentence, index) => {
                    const reason = detection.detected_reason && detection.detected_reason[index] 
                        ? detection.detected_reason[index] 
                        : 'ìœ„ë°˜ ì‚¬ìœ  ë¯¸ì œê³µ';
                    
                    return `
                        <div style="background-color: #fff5f5; border-left: 4px solid #ef4444; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                <span style="background-color: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">ìœ„ë°˜ ${index + 1}</span>
                                <span style="color: #dc2626; font-weight: 500; font-size: 14px;">${reason}</span>
                            </div>
                            <div style="background-color: white; border: 1px solid #fee; border-radius: 6px; padding: 12px;">
                                <p style="margin: 0; color: #444; line-height: 1.6;">"${sentence}"</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                violationSection.style.display = 'block';
                violationCards.innerHTML = `
                    <div style="background-color: #f0fdf4; border-left: 4px solid #10b981; border-radius: 8px; padding: 15px; text-align: center;">
                        <span style="color: #059669; font-weight: 500; font-size: 16px;">âœ“ ìœ„ë°˜ì‚¬í•­ì´ íƒì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>
                    </div>
                `;
            }
            
            // í‚¤ì›Œë“œ ë°°ì§€ ìƒì„±
            const keywordBadges = document.getElementById('keywordBadges');
            const keywordSection = document.getElementById('keywordSection');
            
            if (detection.detected_keyword && detection.detected_keyword.length > 0) {
                keywordSection.style.display = 'block';
                keywordBadges.innerHTML = detection.detected_keyword.map(keyword => {
                    return `<span style="background-color: #3b82f6; color: white; padding: 6px 14px; border-radius: 16px; font-size: 13px; font-weight: 500;">${keyword}</span>`;
                }).join('');
            } else {
                keywordSection.style.display = 'none';
            }
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('analysisDetailModal').style.display = 'flex';
        }

        function closeAnalysisDetailModal() {
            document.getElementById('analysisDetailModal').style.display = 'none';
        }

        function exportResults() {
            // í˜•ì‹ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('exportFormatModal').style.display = 'flex';
        }

        function closeExportFormatModal() {
            document.getElementById('exportFormatModal').style.display = 'none';
        }

        function exportToExcel() {
            try {
                closeExportFormatModal();
                
                // í•„í„°ë§ëœ ê²°ê³¼ ì‚¬ìš©
                const filteredResults = applyFilters(allResults);
                
                // Excel ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                
                // ë°ì´í„° ë°°ì—´ ìƒì„±
                const wsData = [
                    ['ë²ˆí˜¸', 'íŒŒì¼ëª…', 'STT ì „ë¬¸', 'ë¶„ì„ ìƒíƒœ', 'ì¹´í…Œê³ ë¦¬', 'ë¶„ì„ ê²°ê³¼', 'ë¶„ì„ ë‚´ìš© (Detected Sentence)', 'ë¶„ì„ ë‚´ìš© (Detected Reason)', 'ë¶„ì„ ë‚´ìš© (Detected Keyword)']
                ];
                
                // ê° ê²°ê³¼ë¥¼ í–‰ìœ¼ë¡œ ì¶”ê°€
                filteredResults.forEach((result, index) => {
                    // status ë§¤í•‘
                    const statusText = result.status === 'completed' ? 'ì™„ë£Œ' : 
                                      result.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 
                                      result.status === 'processing' ? 'ë¶„ì„ì¤‘' : 
                                      result.status === 'failed' ? 'ì‹¤íŒ¨' : '-';
                    
                    // improper_detection_results íŒŒì‹±
                    let category = '-';
                    let detectionResult = '-';
                    let detectedSentences = '-';
                    let detectedReasons = '-';
                    let detectedKeywords = '-';
                    
                    if (result.status === 'completed' && result.improper_detection_results) {
                        try {
                            const detection = typeof result.improper_detection_results === 'string' 
                                ? JSON.parse(result.improper_detection_results) 
                                : result.improper_detection_results;
                            
                            // ì¹´í…Œê³ ë¦¬
                            if (detection.category) {
                                category = detection.category;
                            }
                            
                            // ë¶„ì„ ê²°ê³¼
                            if (detection.detected_yn === 'Y') {
                                detectionResult = 'ìœ„ë°˜ íƒì§€';
                            } else if (detection.detected_yn === 'N') {
                                detectionResult = 'ì´ìƒ ì—†ìŒ';
                            }
                            
                            // Detected Sentence
                            if (detection.detected_sentence && Array.isArray(detection.detected_sentence)) {
                                detectedSentences = detection.detected_sentence.join(' | ');
                            }
                            
                            // Detected Reason
                            if (detection.detected_reason && Array.isArray(detection.detected_reason)) {
                                detectedReasons = detection.detected_reason.join(' | ');
                            }
                            
                            // Detected Keyword
                            if (detection.detected_keyword && Array.isArray(detection.detected_keyword)) {
                                detectedKeywords = detection.detected_keyword.join(', ');
                            }
                        } catch (e) {
                            console.error('JSON íŒŒì‹± ì—ëŸ¬:', e);
                        }
                    }
                    
                    wsData.push([
                        index + 1,
                        result.filename || '',
                        result.stt_text || '-',
                        statusText,
                        category,
                        detectionResult,
                        detectedSentences,
                        detectedReasons,
                        detectedKeywords
                    ]);
                });
                
                // ì›Œí¬ì‹œíŠ¸ ìƒì„±
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ì—´ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 8 },   // ë²ˆí˜¸
                    { wch: 30 },  // íŒŒì¼ëª…
                    { wch: 80 },  // STT ì „ë¬¸
                    { wch: 12 },  // ë¶„ì„ ìƒíƒœ
                    { wch: 15 },  // ì¹´í…Œê³ ë¦¬
                    { wch: 15 },  // ë¶„ì„ ê²°ê³¼
                    { wch: 50 },  // Detected Sentence
                    { wch: 50 },  // Detected Reason
                    { wch: 30 }   // Detected Keyword
                ];
                
                // ì›Œí¬ë¶ì— ì›Œí¬ì‹œíŠ¸ ì¶”ê°€
                XLSX.utils.book_append_sheet(wb, ws, 'ë¶„ì„ê²°ê³¼');
                
                // Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, `analysis_results_${currentFolderPath}_${new Date().toISOString().slice(0,10)}.xlsx`);
                
                showNotification('Excel íŒŒì¼ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('Excel ë‚´ë³´ë‚´ê¸° ì—ëŸ¬:', error);
                showNotification('Excel ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function exportToCSV() {
            try {
                closeExportFormatModal();
                
                // í•„í„°ë§ëœ ê²°ê³¼ ì‚¬ìš©
                const filteredResults = applyFilters(allResults);
                
                // CSV ë°ì´í„° ìƒì„±
                const csvRows = [];
                
                // í—¤ë” ì¶”ê°€
                csvRows.push(['ë²ˆí˜¸', 'íŒŒì¼ëª…', 'STT ì „ë¬¸', 'ë¶„ì„ ìƒíƒœ', 'ì¹´í…Œê³ ë¦¬', 'ë¶„ì„ ê²°ê³¼', 'ë¶„ì„ ë‚´ìš© (Detected Sentence)', 'ë¶„ì„ ë‚´ìš© (Detected Reason)', 'ë¶„ì„ ë‚´ìš© (Detected Keyword)'].join(','));
                
                // ê° ê²°ê³¼ë¥¼ í–‰ìœ¼ë¡œ ì¶”ê°€
                filteredResults.forEach((result, index) => {
                    // status ë§¤í•‘
                    const statusText = result.status === 'completed' ? 'ì™„ë£Œ' : 
                                      result.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 
                                      result.status === 'processing' ? 'ë¶„ì„ì¤‘' : 
                                      result.status === 'failed' ? 'ì‹¤íŒ¨' : '-';
                    
                    // improper_detection_results íŒŒì‹±
                    let category = '-';
                    let detectionResult = '-';
                    let detectedSentences = '-';
                    let detectedReasons = '-';
                    let detectedKeywords = '-';
                    
                    if (result.status === 'completed' && result.improper_detection_results) {
                        try {
                            const detection = typeof result.improper_detection_results === 'string' 
                                ? JSON.parse(result.improper_detection_results) 
                                : result.improper_detection_results;
                            
                            // ì¹´í…Œê³ ë¦¬
                            if (detection.category) {
                                category = detection.category;
                            }
                            
                            // ë¶„ì„ ê²°ê³¼
                            if (detection.detected_yn === 'Y') {
                                detectionResult = 'ìœ„ë°˜ íƒì§€';
                            } else if (detection.detected_yn === 'N') {
                                detectionResult = 'ì´ìƒ ì—†ìŒ';
                            }
                            
                            // Detected Sentence
                            if (detection.detected_sentence && Array.isArray(detection.detected_sentence)) {
                                detectedSentences = detection.detected_sentence.join(' | ');
                            }
                            
                            // Detected Reason
                            if (detection.detected_reason && Array.isArray(detection.detected_reason)) {
                                detectedReasons = detection.detected_reason.join(' | ');
                            }
                            
                            // Detected Keyword
                            if (detection.detected_keyword && Array.isArray(detection.detected_keyword)) {
                                detectedKeywords = detection.detected_keyword.join(', ');
                            }
                        } catch (e) {
                            console.error('JSON íŒŒì‹± ì—ëŸ¬:', e);
                        }
                    }
                    
                    const sttText = (result.stt_text || '-').replace(/"/g, '""');
                    const detectedSentencesEscaped = detectedSentences.replace(/"/g, '""');
                    const detectedReasonsEscaped = detectedReasons.replace(/"/g, '""');
                    const detectedKeywordsEscaped = detectedKeywords.replace(/"/g, '""');
                    
                    const row = [
                        index + 1,
                        `"${result.filename || ''}"`,
                        `"${sttText}"`,
                        statusText,
                        category,
                        detectionResult,
                        `"${detectedSentencesEscaped}"`,
                        `"${detectedReasonsEscaped}"`,
                        `"${detectedKeywordsEscaped}"`
                    ];
                    csvRows.push(row.join(','));
                });
                
                // CSV íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                const csvContent = '\uFEFF' + csvRows.join('\n'); // UTF-8 BOM ì¶”ê°€
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `analysis_results_${currentFolderPath}_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('CSV íŒŒì¼ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('CSV ë‚´ë³´ë‚´ê¸° ì—ëŸ¬:', error);
                showNotification('CSV ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return encodeURIComponent(text);
        }

        function refreshProgress() {
            console.log('ì§„í–‰ë¥  ìƒˆë¡œê³ ì¹¨');
            checkProgress();
            showNotification('ì§„í–‰ ìƒí™©ì„ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤', 'success');
        }

        function goBack() {
            window.location.href = '/upload';
        }

        async function logout() {
            try {
                const response = await apiCall('/api/auth/logout', 'POST');
                // API í˜¸ì¶œ ê²°ê³¼ì™€ ê´€ê³„ì—†ì´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = '/';
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:', error);
                // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = '/';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ë¶„ì„ ì´ë ¥ ëª¨ë‹¬ í‘œì‹œ
        async function showHistoryModal() {
            try {
                // í˜„ì¬ í´ë” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const progressData = await apiCall(`/api/analysis/progress/${currentJobId}`, 'GET');
                if (!progressData) {
                    return;  // apiCallì´ ì´ë¯¸ ì—ëŸ¬ ì•Œë¦¼ì„ í‘œì‹œí•¨
                }
                
                const currentFolder = progressData.folder_path || '';
                
                // í´ë” ëª©ë¡ ë¡œë“œ
                const filesData = await apiCall('/api/files/folders', 'GET');
                if (!filesData) {
                    return;  // apiCallì´ ì´ë¯¸ ì—ëŸ¬ ì•Œë¦¼ì„ í‘œì‹œí•¨
                }
                
                const folders = filesData.folders || [];
                
                // í´ë” ì„ íƒì§€ ì±„ìš°ê¸°
                const folderSelect = document.getElementById('folderSelect');
                folderSelect.innerHTML = '<option value="">ì „ì²´ í´ë”</option>' + 
                    folders.map(f => `<option value="${f}">${f}</option>`).join('');
                
                // í˜„ì¬ í´ë” ì„ íƒ
                if (currentFolder) {
                    folderSelect.value = currentFolder;
                }
                
                // ë¶„ì„ ì´ë ¥ ë¡œë“œ
                await loadAnalysisHistory(currentFolder);
                
                // ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('historyModal').style.display = 'flex';
                
                // í´ë” ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
                folderSelect.onchange = function() {
                    loadAnalysisHistory(this.value);
                };
            } catch (error) {
                console.error('ë¶„ì„ ì´ë ¥ ëª¨ë‹¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ë¶„ì„ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }

        // ë¶„ì„ ì´ë ¥ ë¡œë“œ
        async function loadAnalysisHistory(folderPath) {
            try {
                const url = folderPath 
                    ? `/api/analysis/history?folder_path=${encodeURIComponent(folderPath)}`
                    : '/api/analysis/history';
                
                const response = await apiCall(url, 'GET');
                if (!response) {
                    return;  // apiCallì´ ì´ë¯¸ ì—ëŸ¬ ì•Œë¦¼ì„ í‘œì‹œí•¨
                }
                
                const history = response.data || [];
                
                // ì´ë ¥ ëª©ë¡ ë Œë”ë§
                const historyListHtml = history.length > 0
                    ? history.map(job => `
                        <div class="history-item" onclick="viewAnalysis('${job.job_id}')">
                            <div class="history-item-info">
                                <div class="history-item-title">
                                    ${job.folder_path}
                                    <span class="history-item-badge ${getBadgeClass(job.status)}">${getStatusText(job.status)}</span>
                                </div>
                                <div class="history-item-meta">
                                    ${job.completed_files || 0} / ${job.total_files} íŒŒì¼ ì™„ë£Œ
                                    | ${new Date(job.created_at).toLocaleString('ko-KR')}
                                </div>
                            </div>
                            <button class="btn btn-back" style="margin: 0;" onclick="event.stopPropagation(); viewAnalysis('${job.job_id}')">
                                ë³´ê¸°
                            </button>
                        </div>
                    `).join('')
                    : '<div style="text-align: center; padding: 20px; color: #999;">ë¶„ì„ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                
                document.getElementById('historyList').innerHTML = historyListHtml;
            } catch (error) {
                console.error('ë¶„ì„ ì´ë ¥ ì¡°íšŒ ì—ëŸ¬:', error);
                showNotification('ë¶„ì„ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨', 'error');
            }
        }

        // ë¶„ì„ ê²°ê³¼ ë³´ê¸°
        function viewAnalysis(jobId) {
            window.location.href = `/analysis?job_id=${jobId}`;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'processing': 'ë¶„ì„ì¤‘',
                'completed': 'ì™„ë£Œ',
                'failed': 'ì‹¤íŒ¨'
            };
            return statusMap[status] || status;
        }

        // ìƒíƒœë³„ ë°°ì§€ í´ë˜ìŠ¤
        function getBadgeClass(status) {
            const classMap = {
                'pending': 'badge-pending',
                'processing': 'badge-processing',
                'completed': 'badge-completed',
                'failed': 'badge-failed'
            };
            return classMap[status] || 'badge-pending';
        }

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            await initPage();
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const historyModal = document.getElementById('historyModal');
            const sttTextModal = document.getElementById('sttTextModal');
            const analysisDetailModal = document.getElementById('analysisDetailModal');
            
            if (event.target === historyModal) {
                closeHistoryModal();
            }
            if (event.target === sttTextModal) {
                closeSttTextModal();
            }
            if (event.target === analysisDetailModal) {
                closeAnalysisDetailModal();
            }
        });

        // ===== CHECKBOX AND RERUN FUNCTIONS =====

        function handleFileCheckbox(filename, isChecked) {
            if (isChecked) {
                selectedFiles.add(filename);
            } else {
                selectedFiles.delete(filename);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const filteredResults = applyFilters(allResults);
            
            if (checkbox.checked) {
                // Add all filtered files to selection
                filteredResults.forEach(result => {
                    selectedFiles.add(result.filename);
                });
            } else {
                // Remove all filtered files from selection
                filteredResults.forEach(result => {
                    selectedFiles.delete(result.filename);
                });
            }
            
            // Re-render to update checkbox states
            renderResults(allResults);
            updateSelectionUI();
        }

        function selectAllFiltered() {
            const filteredResults = applyFilters(allResults);
            filteredResults.forEach(result => {
                selectedFiles.add(result.filename);
            });
            renderResults(allResults);
            updateSelectionUI();
        }

        function deselectAll() {
            selectedFiles.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            renderResults(allResults);
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedFiles.size;
            
            // Update badge count in button
            const badgeElement = document.getElementById('selectedCountBadge');
            if (badgeElement) {
                badgeElement.textContent = count;
            }
            
            const rerunBtn = document.getElementById('rerunBtn');
            if (rerunBtn) {
                rerunBtn.disabled = count === 0;
            }
            
            // Update "select all" checkbox state
            const filteredResults = applyFilters(allResults);
            const allFilteredSelected = filteredResults.length > 0 && 
                filteredResults.every(r => selectedFiles.has(r.filename));
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allFilteredSelected;
            }
        }

        async function rerunSelectedFiles() {
            if (selectedFiles.size === 0) {
                showNotification('ì¬ì‹¤í–‰í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'warning');
                return;
            }
            
            const confirmed = confirm(`ì„ íƒí•œ ${selectedFiles.size}ê°œ íŒŒì¼ì„ ì¬ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!confirmed) return;
            
            try {
                const selectedFilesArray = Array.from(selectedFiles);
                
                const response = await apiCall('/api/analysis/rerun', 'POST', {
                    job_id: currentJobId,
                    filenames: selectedFilesArray,
                    folder_path: currentFolderPath,
                    include_classification: currentIncludeClassification,
                    include_validation: currentIncludeValidation
                });
                
                if (response && response.success) {
                    showNotification(`ì¬ë¶„ì„ ì‹œì‘: ${response.file_count}ê°œ íŒŒì¼`, 'success');
                    
                    // Clear selection and stay on the same page
                    selectedFiles.clear();
                    updateSelectionUI();
                    
                    // Restart polling interval for real-time updates
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                    progressInterval = setInterval(checkProgress, 2000);
                    
                    // Force immediate progress check to see the reset files
                    setTimeout(() => {
                        checkProgress();
                    }, 500);
                } else {
                    showNotification('ì¬ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('ì¬ë¶„ì„ ìš”ì²­ ì—ëŸ¬:', error);
                showNotification('ì¬ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }
    </script>
</body>
</html>

